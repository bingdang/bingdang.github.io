<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>k8s企业级DevOps实践-StatefulSet&amp;Helm v3 | Maxbit</title><meta name="author" content="饼铛"><meta name="copyright" content="饼铛"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="什么是 StatefulSetStatefulSet 是用来管理有状态的应用，例如数据库,consul，zookeeper等集群。  通过Deployment部署的应用，都是不需要存储数据，不需要记住状态且pod之间没有任何依赖关系，可以随意扩充副本，每个副本都是一样的，可替代的。 而像数据库、Redis、kafka、consul这类有状态的，则不能随意扩充副本。就需要用到StatefulSet这">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s企业级DevOps实践-StatefulSet&amp;Helm v3">
<meta property="og:url" content="https://cakepanit.com/forward/7139bb18.html">
<meta property="og:site_name" content="Maxbit">
<meta property="og:description" content="什么是 StatefulSetStatefulSet 是用来管理有状态的应用，例如数据库,consul，zookeeper等集群。  通过Deployment部署的应用，都是不需要存储数据，不需要记住状态且pod之间没有任何依赖关系，可以随意扩充副本，每个副本都是一样的，可替代的。 而像数据库、Redis、kafka、consul这类有状态的，则不能随意扩充副本。就需要用到StatefulSet这">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cakepanit.com/images/pasted-146.png">
<meta property="article:published_time" content="2022-01-04T14:07:00.000Z">
<meta property="article:modified_time" content="2022-07-16T01:09:53.902Z">
<meta property="article:author" content="饼铛">
<meta property="article:tag" content="OPS">
<meta property="article:tag" content="Zookeeper">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="StatefuSet">
<meta property="article:tag" content="Helm v3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cakepanit.com/images/pasted-146.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cakepanit.com/forward/7139bb18.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/fei/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/fei/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":100,"languages":{"author":"作者: 饼铛","link":"链接: ","source":"来源: Maxbit","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'k8s企业级DevOps实践-StatefulSet&Helm v3',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-16 09:09:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/fei/swiper-bundle.min.css"><script src="/css/fei/swiper-bundle.min.js"></script><script src="/css/fei/pace.min.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">95</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-book-open"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa-fw fas fa-archive"></i><span> 文章列表</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa-fw fas fa-shapes"></i><span> 全部分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa-fw fas fa-tags"></i><span> 所有标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fa-fw fas fa-chart-line"></i><span> 文章统计</span></a></li><li><a class="site-page child" href="javascript:toRandomPost();"><i class="fa-fw fa-fw fas fa-random"></i><span> 随便看看</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-link"></i><span> 导航</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fa-fw fas fa-child"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fa-fw fas fa-address-card"></i><span> 关于本站</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-file-image"></i><span> 收藏图库</span></a></li><li><a class="site-page child" href="/bookshelf/"><i class="fa-fw fas fa-bookmark"></i><span> 收藏书单</span></a></li><li><a class="site-page child" href="/status"><i class="fa-fw fab fa-accessible-icon"></i><span> 站点监控</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/pasted-146.png')"><nav id="nav"><div id="nav-group"><span id="blog-info"> <a class="site-page" href="/" title="Maxbit"><span class="site-name">Maxbit</span><i class="fas fa-home"></i></a></span><span id="page_name"><a class="site-page" id="page-title" title="回到顶部" onclick="btf.scrollToDest(0, 500)"><span>Maxbit</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-book-open"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa-fw fas fa-archive"></i><span> 文章列表</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa-fw fas fa-shapes"></i><span> 全部分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa-fw fas fa-tags"></i><span> 所有标签</span></a></li><li><a class="site-page child" href="/charts/"><i class="fa-fw fa-fw fas fa-chart-line"></i><span> 文章统计</span></a></li><li><a class="site-page child" href="javascript:toRandomPost();"><i class="fa-fw fa-fw fas fa-random"></i><span> 随便看看</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-link"></i><span> 导航</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fa-fw fas fa-child"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fa-fw fas fa-address-card"></i><span> 关于本站</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-file-image"></i><span> 收藏图库</span></a></li><li><a class="site-page child" href="/bookshelf/"><i class="fa-fw fas fa-bookmark"></i><span> 收藏书单</span></a></li><li><a class="site-page child" href="/status"><i class="fa-fw fab fa-accessible-icon"></i><span> 站点监控</span></a></li></ul></div></div></div><div id="hotkey"><div id="setting-button" onclick="eurkon.switchRightSide();"><a class="site-page" href="javascript:void(0);" title="设置"><i class="fas fa-screwdriver-wrench fa-fw"></i></a></div><div id="top-button"><a class="site-page" href="javascript:void(0);" title="回到顶部" onclick="btf.scrollToDest(0, 500)"><span class="scroll-percent"></span><i class="fas fa-arrow-up fa-fw"></i></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-cover"><img class="cover" id="post-cover-img" src="/images/pasted-146.png" alt="cover"></div><div id="post-info"><div id="post-meta"><div class="meta-firstline"><span class="post-meta-categories"><i class="fas fa-shapes fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/OPS/">OPS</a></span><span class="post-meta-tags"><span class="post-meta-separator">|</span><i class="fas fa-tags fa-fw post-meta-icon"></i><a class="post-meta-tags" href="/tags/OPS/">🌍OPS</a><span class="post-meta-separator">•</span><a class="post-meta-tags" href="/tags/Zookeeper/">Zookeeper</a><span class="post-meta-separator">•</span><a class="post-meta-tags" href="/tags/Kubernetes/">⛵Kubernetes</a><span class="post-meta-separator">•</span><a class="post-meta-tags" href="/tags/StatefuSet/">StatefuSet</a><span class="post-meta-separator">•</span><a class="post-meta-tags" href="/tags/Helm-v3/">Helm v3</a></span></div><h1 class="post-title">k8s企业级DevOps实践-StatefulSet&amp;Helm v3</h1><div class="meta-secondline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-04T14:07:00.000Z" title="发表于 2022-01-04 22:07:00">2022-01-04</time></span><span class="post-meta-separator">|</span><span class="post-meta-date"><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-16T01:09:53.902Z" title="更新于 2022-07-16 09:09:53">2022-07-16</time></span><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.1k</span><span class="post-meta-separator">|</span></span><span class="post-meta-min2read"><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>30分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="k8s企业级DevOps实践-StatefulSet&amp;Helm v3"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div><div id="post"><article class="post-content" id="article-container"><h2 id="什么是-StatefulSet"><a href="#什么是-StatefulSet" class="headerlink" title="什么是 StatefulSet"></a>什么是 StatefulSet</h2><p><code>StatefulSet</code> 是用来管理有状态的应用，例如数据库,consul，zookeeper等集群。</p>
<ol>
<li>通过<code>Deployment</code>部署的应用，都是不需要存储数据，不需要记住状态且pod之间没有任何依赖关系，可以随意扩充副本，每个副本都是一样的，可替代的。</li>
<li>而像数据库、Redis、kafka、consul这类有状态的，则不能随意扩充副本。就需要用到<code>StatefulSet</code>这种工作负载类型会固定每个 Pod 的名字</li>
</ol>
<h2 id="什么是-PDB"><a href="#什么是-PDB" class="headerlink" title="什么是 PDB"></a>什么是 PDB</h2><p><code>PodDisruptionBudget</code> 这个控制器直译就是[Pod 干扰 预算]，这个控制器主要是通过设置应用 Pod 处于正常状态的最低个数或最低百分比，这样可以保证在主动销毁 Pod 的时候，不会销毁太多的 Pod 导致业务异常中断，从而提高业务的可用性。</p>
<p>是不是类似于<code>Deployment</code>中的<code>maxUnavailable</code>和<code>RS Controller</code>呢，三者看上去都是有一个保持 Pod 的最低个数或者百分比的设置。其实后两个并不能给你保证集群中始终有几个副本的，他们只是让实际副本数跟你的期望副本数尽快的一致，但这个过程中的副本数量并不关心。所以这个时候就要考虑使用 PDB 了，对那些Voluntary Disruption（自愿中断）做好Budgets（预算）。</p>
<h3 id="Involuntary-AND-Voluntary"><a href="#Involuntary-AND-Voluntary" class="headerlink" title="Involuntary AND Voluntary"></a>Involuntary AND Voluntary</h3><p>对 Voluntary Disruption 的情况，我们可以使用PDB做预算。哪些情况是 Involuntary Disruption，哪些又是 Voluntary Disruption 呢？</p>
<p><strong>Involuntary Disruption：</strong></p>
<ul>
<li>服务器硬件故障或者内核崩溃导致节点宕了；</li>
<li>如果节点是 KVM，Xen 虚拟机，虚拟机被删了或者 KVM，Xen 崩了；</li>
<li>集群网络脑裂；</li>
<li>某个节点因为不合理的超配导致出现计算资源不足时，触发了 kubelet eviction；<br>这些都是 Kubernetes 不可控的情况，这些情况下不适用于PDB。</li>
</ul>
<p><strong>Voluntary Disruption：</strong></p>
<ul>
<li>删除 Deployment，RC，StatefulSet控制器</li>
<li>更新了 Pod 模版，触发 Pod 滚动更新</li>
<li>批量删除Pod</li>
<li>清空节点</li>
<li>下线一个节点</li>
</ul>
<h3 id="PDB-关键参数与注意事项"><a href="#PDB-关键参数与注意事项" class="headerlink" title="PDB 关键参数与注意事项"></a>PDB 关键参数与注意事项</h3><ul>
<li><code>.spec.minAvailable</code>表示发生自愿中断的过程中，要保证至少可用的Pods数或者比例</li>
<li><code>.spec.maxUnavailable</code>表示发生自愿中断的过程中，要保证最大不可用的Pods数或者比例<br>上面配置只能用来对应 Deployment，RS，RC，StatefulSet的Pods，推荐优先使用 <code>.spec.maxUnavailable</code>。</li>
</ul>
<p>注意：</p>
<ul>
<li>同一个 PDB Object 中<strong>不能同时定义</strong> <code>.spec.minAvailable</code> 和 <code>.spec.maxUnavailable</code>。</li>
<li>前面提到，应用滚动更新时Pod的delete和unavailable虽然也属于自愿中断，但是实际上滚动更新有自己的策略控制（marSurge 和 maxUnavailable），因此PDB不会干预这个过程。</li>
<li>PDB 只能保证自愿中断时的副本数，比如 eviction pod过程中刚好满足 <code>.spec.minAvailable</code> 或<code>.spec.maxUnavailable</code>，这时某个本来正常的Pod突然因为Node Down(非自愿中断)挂了，那么这个时候实际Pods数就比PDB中要求的少了，因此PDB不是万能的！</li>
<li>使用上，如果设置 <code>.spec.minAvailable</code> 为 100% 或者 <code>.spec.maxUnavailable</code> 为 0%，意味着会完全阻止 eviction pods 的过程（ Deployment和StatefulSet的滚动更新除外 ）。</li>
</ul>
<h3 id="PDB-for-Zookeeper"><a href="#PDB-for-Zookeeper" class="headerlink" title="PDB for Zookeeper"></a>PDB for Zookeeper</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk-pdb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">baseservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line">  <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># pod 干扰预算定义的示例，它们与带有 app: zk 标签的 pod 相匹配</span></span><br><span class="line"><span class="comment"># 上面的PDB选择的是一个规格为 3 的 StatefulSet，因为zk三节点集群中。最少需要保证两个节点可用zk集群才可用</span></span><br></pre></td></tr></table></figure>

<h2 id="Service和DNS的关系"><a href="#Service和DNS的关系" class="headerlink" title="Service和DNS的关系"></a>Service和DNS的关系</h2><p>在kubernetes中,所有的Service和Pod都会被分配一条对应的DNS A记录( 通过域名解析到IP地址的记录 )</p>
<h4 id="ClusterIP-Service的DNS分配方式"><a href="#ClusterIP-Service的DNS分配方式" class="headerlink" title="ClusterIP Service的DNS分配方式"></a>ClusterIP Service的DNS分配方式</h4><p>ClusterIP模式的NormalService 来说,它的 A 记录的格式是:<br><code>myservicename.mynamespace.svc.cluster.local</code> 当你访问这条 A 记录的时候,它解析到的就是该Service的VIP地址</p>
<h4 id="Headliness-Service的DNS分配方式"><a href="#Headliness-Service的DNS分配方式" class="headerlink" title="Headliness Service的DNS分配方式"></a>Headliness Service的DNS分配方式</h4><p>ClusterIP=None的 HeadlessService 来说,它的 A 记录的格式也是:<br><code>myservicename.mynamespace.svc.cluster.local</code> 当你访问这条A记录的时候,它返回的是所有被代理的Pod的IP地址的集合.当然,如果你的客户端没办法解析这个集合的话,它可能会只会拿到第一个Pod的IP地址</p>
<p>ClusterIP Service被代理Pod的分配方式<br>对于ClusterIP模式的Service来说,它代理的Pod被自动分配的A记录的格式是:<br><code>PodIP.mynamespace.pod.cluster.local</code>这条记录指向Pod的IP地址</p>
<p>Headliness Service被代理Pod的分配方式</p>
<ol>
<li>对Headless Service 来说,它代理的Pod被自动分配的A记录的格式是:<br><code>mypodname.myservicename.mynamespace.svc.cluster.local</code> 这条记录也指向Pod的IP地址</li>
<li>如果Pod本身声明了hostname和subdomain字段,那么这时候Pod的A记录就会变成:  <code>podhostname.mysubdomain.mynamespace.svc.cluster.local</code></li>
</ol>
<h2 id="什么是-HeadLess"><a href="#什么是-HeadLess" class="headerlink" title="什么是 HeadLess"></a>什么是 HeadLess</h2><h3 id="Normal和Headless对比"><a href="#Normal和Headless对比" class="headerlink" title="Normal和Headless对比"></a>Normal和Headless对比</h3><p>写法方面：<br><img src="/images/pasted-147.png" alt="NormalService vs HeadlessService"></p>
<h3 id="工作方式对比"><a href="#工作方式对比" class="headerlink" title="工作方式对比"></a>工作方式对比</h3><h4 id="NormalService"><a href="#NormalService" class="headerlink" title="NormalService"></a>NormalService</h4><p>工作方式是通过一个Cluster-ip <code>10.0.0.112:80</code> 来反向代理 endpoints 列表中的 pod 地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.244.4.10:80  10.244.6.160:80    10.244.8.32:80</span><br></pre></td></tr></table></figure>
<p><img src="/images/pasted-150.png" alt="apiA"><br><img src="/images/pasted-148.png" alt="NormalService"></p>
<p>此时要访问apiA这个接口只需要访问到这个Cluster-ip，就可以实现对后端POD的负载均衡</p>
<h4 id="HeadlessService"><a href="#HeadlessService" class="headerlink" title="HeadlessService"></a>HeadlessService</h4><p>工作方式是并不会分配 Cluster IP，kube-proxy 不会处理它们，而且平台也不会为它们进行负载均衡和路由。 DNS 如何实现自动配置，依赖于 Service 是否定义了 selector。<br>如下图：<br><img src="/images/pasted-149.png" alt="zookeeper"></p>
<p>此时要访问zookeeper这个集群，需要按照<br><code>&lt;pod-name&gt;.&lt;service-name&gt;.&lt;namespace-name&gt;..svc.cluster.local</code>就可以访问到zk集群中指定pod，相当于给pod分配了一个可解析身份，非常适合用作<code>StatefulSet</code>类型工作负载中pod之间进行内部通信。</p>
<h3 id="HeadLess的作用"><a href="#HeadLess的作用" class="headerlink" title="HeadLess的作用"></a>HeadLess的作用</h3><p>简而言之<code>Headless Service</code>就是没头的Service。有啥用呢？很简单，有时候client想自己来决定使用哪个Real Server时可以通过查询DNS来获取Real Server的信息。Headless Service的对应的每一个Endpoints，即每一个Pod，都会有对应的DNS域名；这样Pod之间就可以互相访问。</p>
<h2 id="Zookeeper容器化部署"><a href="#Zookeeper容器化部署" class="headerlink" title="Zookeeper容器化部署"></a>Zookeeper容器化部署</h2><h3 id="编排PV持久化存储"><a href="#编排PV持久化存储" class="headerlink" title="编排PV持久化存储"></a>编排PV持久化存储</h3><p>参考文档:<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tutorials/stateful-application/zookeeper/">https://kubernetes.io/zh/docs/tutorials/stateful-application/zookeeper/</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-pv-zk1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span> <span class="comment">#允许一个节点挂载</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vers=3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nolock,tcp,noresvport</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/zk/zk1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">71cc1489fb-kmn77.ap-southeast-1.nas.aliyuncs.com</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-pv-zk2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span> <span class="comment">#允许一个节点挂载</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vers=3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nolock,tcp,noresvport</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span> <span class="comment">#不清理, 保留 Volume（需要手动清理）</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/zk/zk2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">71cc1489fb-kmn77.ap-southeast-1.nas.aliyuncs.com</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-pv-zk3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span> <span class="comment">#允许一个节点挂载</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vers=3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nolock,tcp,noresvport</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span> <span class="comment">#不清理, 保留 Volume（需要手动清理）</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/zk/zk3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">71cc1489fb-kmn77.ap-southeast-1.nas.aliyuncs.com</span></span><br></pre></td></tr></table></figure>
<p>应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl apply -f zk-pv.yaml</span></span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl get pv | grep Available</span></span><br><span class="line">k8s-pv-zk1                           5Gi        RWO            Retain           Available                                                   nfs                     23s</span><br><span class="line">k8s-pv-zk2                           5Gi        RWO            Retain           Available                                                   nfs                     23s</span><br><span class="line">k8s-pv-zk3                           5Gi        RWO            Retain           Available                                                   nfs                     23s</span><br></pre></td></tr></table></figure>

<h3 id="部署Service-amp-PDB"><a href="#部署Service-amp-PDB" class="headerlink" title="部署Service &amp; PDB"></a>部署Service &amp; PDB</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk-headless</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">baseservice</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">2888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">leader-election</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span> <span class="comment">#headless模式，用于zk p2p内部选举</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">baseservice</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">2181</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk-pdb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">baseservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line">  <span class="attr">maxUnavailable:</span> <span class="number">1</span> <span class="comment">#自发干扰时最多允许一个节点宕机</span></span><br></pre></td></tr></table></figure>
<p>应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl apply -f svc.yaml</span></span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl get svc -n baseservice | grep zk</span></span><br><span class="line">zk-headless       ClusterIP   None         &lt;none&gt;        2888/TCP,3888/TCP   41s</span><br><span class="line">zk-service        ClusterIP   10.0.0.140   &lt;none&gt;        2181/TCP            41s</span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl get pdb -n baseservice </span></span><br><span class="line">NAME     MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE</span><br><span class="line">zk-pdb   N/A             1                 0                     64s</span><br></pre></td></tr></table></figure>
<h3 id="部署StatefulSet"><a href="#部署StatefulSet" class="headerlink" title="部署StatefulSet"></a>部署StatefulSet</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">baseservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">zk-headless</span> <span class="comment">#必须关联到一个无头服务商</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span> <span class="comment">#更新策略: 滚动更新</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span> <span class="comment">#串行启动pod即一个一个启动</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-zookeeper</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment">#拉取策略</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">&quot;k8s.gcr.io/kubernetes-zookeeper:1.0-3.4.10&quot;</span></span><br><span class="line">        <span class="attr">resources:</span> <span class="comment">#资源限制</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;0.5&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2181</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2888</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3888</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">leader-election</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;start-zookeeper \</span></span><br><span class="line"><span class="string">          --servers=3 \</span></span><br><span class="line"><span class="string">          --data_dir=/var/lib/zookeeper/data \</span></span><br><span class="line"><span class="string">          --data_log_dir=/var/lib/zookeeper/data/log \</span></span><br><span class="line"><span class="string">          --conf_dir=/opt/zookeeper/conf \</span></span><br><span class="line"><span class="string">          --client_port=2181 \</span></span><br><span class="line"><span class="string">          --election_port=3888 \</span></span><br><span class="line"><span class="string">          --server_port=2888 \</span></span><br><span class="line"><span class="string">          --tick_time=2000 \</span></span><br><span class="line"><span class="string">          --init_limit=10 \</span></span><br><span class="line"><span class="string">          --sync_limit=5 \</span></span><br><span class="line"><span class="string">          --heap=512M \</span></span><br><span class="line"><span class="string">          --max_client_cnxns=60 \</span></span><br><span class="line"><span class="string">          --snap_retain_count=3 \</span></span><br><span class="line"><span class="string">          --purge_interval=12 \</span></span><br><span class="line"><span class="string">          --max_session_timeout=40000 \</span></span><br><span class="line"><span class="string">          --min_session_timeout=4000 \</span></span><br><span class="line"><span class="string">          --log_level=INFO&quot;</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;zookeeper-ready 2181&quot;</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;zookeeper-ready 2181&quot;</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/zookeeper</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">datadir</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;nfs&quot;</span> <span class="comment">#一定要写，如果pv中存在</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure>
<p>应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl apply -f zk.yaml</span></span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl -n baseservice get pod | grep zk</span></span><br><span class="line">zk-0                               1/1     Running     0          7m30s</span><br><span class="line">zk-1                               1/1     Running     0          6m29s</span><br><span class="line">zk-2                               1/1     Running     0          3m54s</span><br><span class="line"></span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl -n baseservice get pv | grep zk</span></span><br><span class="line">k8s-pv-zk1                           5Gi        RWO            Retain           Bound    baseservice/datadir-zk-0                        nfs                     7m19s</span><br><span class="line">k8s-pv-zk2                           5Gi        RWO            Retain           Bound    baseservice/datadir-zk-1                        nfs                     7m19s</span><br><span class="line">k8s-pv-zk3                           5Gi        RWO            Retain           Bound    baseservice/datadir-zk-2                        nfs                     7m19s</span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl -n baseservice get pvc | grep zk</span></span><br><span class="line">datadir-zk-0     Bound    k8s-pv-zk1      5Gi        RWO            nfs            7m54s</span><br><span class="line">datadir-zk-1     Bound    k8s-pv-zk2      5Gi        RWO            nfs            6m53s</span><br><span class="line">datadir-zk-2     Bound    k8s-pv-zk3      5Gi        RWO            nfs            6m35s</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看配置</span></span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl exec -n baseservice zk-0 -- cat /opt/zookeeper/conf/zoo.cfg</span></span><br><span class="line"><span class="comment">#This file was autogenerated DO NOT EDIT</span></span><br><span class="line">clientPort=2181</span><br><span class="line">dataDir=/var/lib/zookeeper/data</span><br><span class="line">dataLogDir=/var/lib/zookeeper/data/log</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">maxClientCnxns=60</span><br><span class="line">minSessionTimeout=4000</span><br><span class="line">maxSessionTimeout=40000</span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line">autopurge.purgeInteval=12</span><br><span class="line">server.1=zk-0.zk-headless.baseservice.svc.cluster.local:2888:3888</span><br><span class="line">server.2=zk-1.zk-headless.baseservice.svc.cluster.local:2888:3888</span><br><span class="line">server.3=zk-2.zk-headless.baseservice.svc.cluster.local:2888:3888</span><br><span class="line"></span><br><span class="line"><span class="comment">#集群状态</span></span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl exec -n baseservice zk-0 zkServer.sh status</span></span><br><span class="line">kubectl <span class="built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl kubectl <span class="built_in">exec</span> [POD] -- [COMMAND] instead.</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl exec -n baseservice zk-1 zkServer.sh status</span></span><br><span class="line">kubectl <span class="built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl kubectl <span class="built_in">exec</span> [POD] -- [COMMAND] instead.</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line">[root@node002 Statefulset]<span class="comment"># kubectl exec -n baseservice zk-2 zkServer.sh status</span></span><br><span class="line">kubectl <span class="built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl kubectl <span class="built_in">exec</span> [POD] -- [COMMAND] instead.</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/bin/../etc/zookeeper/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure>
<p><img src="/images/pasted-152.png" alt="zookeeper"></p>
<h2 id="StatefulSet总结"><a href="#StatefulSet总结" class="headerlink" title="StatefulSet总结"></a>StatefulSet总结</h2><p>上面使用Statefulset控制器搭建了Zookeeper分布式集群，了解到Statefulset具备以下特点：</p>
<ul>
<li>稳定且唯一的网络标识符</li>
<li>稳定且持久的存储</li>
<li>有序，平滑的部署和扩展</li>
<li>有序，平滑的删除和终止</li>
<li>有序的滚动更新<br>且了解到Statefulset包含三个组件：<code>headless service</code>、<code>StatefulSet</code>，<code>volumeClaimTemplate</code></li>
<li><code>headless service</code>：确保解析名称直达后端pod</li>
<li><code>volumeClaimTemplate</code>：卷申请模板，每创建一个pod时，自动申请一个pvc，从而请求绑定pv</li>
<li><code>StatefulSet</code>：有状态服务的控制器</li>
</ul>
<h2 id="什么是Helm"><a href="#什么是Helm" class="headerlink" title="什么是Helm"></a>什么是Helm</h2><p>Helm 是一个 Kubernetes 的包管理工具，类似 Linux 的包管理器，如RedHat系的yum、Debian的apt，可以很方便的将之前打包好的 yaml 文件部署到 Kubernetes 上。Helm主要解决以下问题：</p>
<ol>
<li>把yaml作为一个整体管理。</li>
<li>实现yaml的高效复用。</li>
<li>实现应用级别的版本管理。</li>
</ol>
<p>当前 Helm 已经升级到V3版本，相比于V2版本主要变化如下：</p>
<ol>
<li>最明显的变化是删除了 Tiller 。</li>
<li>Release 名称可以在不同命名空间重用。</li>
<li>支持将 Chart 推送至 Docker 镜像仓库中。</li>
<li>使用 JSONSchema 验证 chart values。</li>
</ol>
<p>Helm是官方提供类似于YUM的包管理，是部署环境的流程封装，Helm有三个重要的概念：<code>chart</code>、<code>release</code>和<code>Repository</code></p>
<ul>
<li><code>chart</code>是创建一个应用的信息集合，包括各种Kubernetes对象的配置模板、参数定义、依赖关系、文档说明等。可以将chart想象成apt、yum中的软件安装包。</li>
<li><code>release</code>是chart的运行实例，代表一个正在运行的应用。当chart被安装到Kubernetes集群，就生成一个release。chart能多次安装到同一个集群，每次安装都是一个release[根据chart赋值不同，完全可以部署出多个release出来]。</li>
<li><code>Repository</code>用于发布和存储 Chart 的存储库。</li>
</ul>
<p>Helm V2 与 Helm V3 的架构图对比：<br><img src="/images/pasted-169.png" alt="Helm"><br>在V2版本的架构中，Tiller在Kubernetes集群中，Helm Client发请求给Tiller需要经过RBAC认证。而在V3版本是Helm通过kubeconfig连接kube-apiserver，避免了使用者去配置RBAC权限。</p>
<p>Helm发布与传统发布对比：<br><img src="/images/pasted-170.png" alt="helmdp"><br>Helm是 Kubernetes 的包管理器，它将应用程序的所有资源和部署信息(*.yaml)组合到单个部署包中。从而实现应用快速安装到Kubernetes集群中。（通过Yaml的配置模板，将需要修改的内容变为属性值）</p>
<h2 id="安装Helm-v3"><a href="#安装Helm-v3" class="headerlink" title="安装Helm v3"></a>安装Helm v3</h2><p>安装Helm V3版本非常简单，只需要下载Helm的二进制文件，并复制到 Kubernetes 主节点的 <code>/usr/bin</code> 目录即可。</p>
<p>Helm下载地址: <a target="_blank" rel="noopener" href="https://get.helm.sh/helm-v3.4.2-linux-amd64.tar.gz">https://get.helm.sh/helm-v3.4.2-linux-amd64.tar.gz</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]<span class="comment"># wget https://get.helm.sh/helm-v3.4.2-linux-amd64.tar.gz</span></span><br><span class="line">--2022-02-09 16:16:34--  https://get.helm.sh/helm-v3.4.2-linux-amd64.tar.gz</span><br><span class="line">Resolving get.helm.sh (get.helm.sh)... 152.199.39.108, 2606:2800:247:1cb7:261b:1f9c:2074:3c</span><br><span class="line">Connecting to get.helm.sh (get.helm.sh)|152.199.39.108|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 13317454 (13M) [application/x-tar]</span><br><span class="line">Saving to: ‘helm-v3.4.2-linux-amd64.tar.gz’</span><br><span class="line"></span><br><span class="line">100%[===============================================================================================================&gt;] 13,317,454  --.-K/s   <span class="keyword">in</span> 0.08s   </span><br><span class="line"></span><br><span class="line">2022-02-09 16:16:35 (151 MB/s) - ‘helm-v3.4.2-linux-amd64.tar.gz’ saved [13317454/13317454]</span><br><span class="line"></span><br><span class="line">[root@node001 ~]<span class="comment"># tar -xf helm-v3.4.2-linux-amd64.tar.gz</span></span><br><span class="line">[root@node001 ~]<span class="comment"># cp linux-amd64/helm /usr/local/bin/</span></span><br><span class="line">[root@node001 ~]<span class="comment"># helm version</span></span><br><span class="line">version.BuildInfo&#123;Version:<span class="string">&quot;v3.4.2&quot;</span>, GitCommit:<span class="string">&quot;23dd3af5e19a02d4f4baa5b2f242645a1a3af629&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, GoVersion:<span class="string">&quot;go1.14.13&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Helm命令补全</span></span><br><span class="line">[root@node001 ~]<span class="comment"># yum install -y bash-completion </span></span><br><span class="line">Loaded plugins: fastestmirror, langpacks, update-motd</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">base                                                                                                                              | 3.1 kB  00:00:00     </span><br><span class="line">docker-ce-stable                                                                                                                  | 3.5 kB  00:00:00     </span><br><span class="line">epel                                                                                                                              | 4.7 kB  00:00:00     </span><br><span class="line">extras                                                                                                                            | 2.5 kB  00:00:00     </span><br><span class="line">plus                                                                                                                              | 2.9 kB  00:00:00     </span><br><span class="line">updates                                                                                                                           | 2.9 kB  00:00:00     </span><br><span class="line">updates/2.1903/x86_64/primary_db                                                                                                  |  10 MB  00:00:00     </span><br><span class="line">Package 1:bash-completion-2.1-8.1.al7.noarch already installed and latest version</span><br><span class="line">Nothing to <span class="keyword">do</span></span><br><span class="line">[root@node001 ~]<span class="comment"># source /usr/share/bash-completion/bash_completion</span></span><br><span class="line">[root@node001 ~]<span class="comment"># source &lt;(helm completion bash) </span></span><br><span class="line">[root@node001 ~]<span class="comment"># echo &quot;source &lt;(helm completion bash)&quot; &gt;&gt; ~/.bashrc</span></span><br><span class="line">[root@node001 ~]<span class="comment"># helm ver&lt;tab&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Helm常用命令"><a href="#Helm常用命令" class="headerlink" title="Helm常用命令"></a>Helm常用命令</h2><table>
<thead>
<tr>
<th align="center">命令</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">create</td>
<td align="left">创建一个chart并指定名字</td>
</tr>
<tr>
<td align="center">dependency</td>
<td align="left">管理chart依赖</td>
</tr>
<tr>
<td align="center">get</td>
<td align="left">下载一个release。可用子命令：all、hooks、manifest、notes、values</td>
</tr>
<tr>
<td align="center">history</td>
<td align="left">获取release历史</td>
</tr>
<tr>
<td align="center">install</td>
<td align="left">安装一个chart</td>
</tr>
<tr>
<td align="center">list</td>
<td align="left">列出release</td>
</tr>
<tr>
<td align="center">package</td>
<td align="left">将chart目录打包到chart存档文件中</td>
</tr>
<tr>
<td align="center">pull</td>
<td align="left">从远程仓库中下载chart并解压到本地 # helm pull stable/mysql –untar</td>
</tr>
<tr>
<td align="center">repo</td>
<td align="left">添加，列出，移除，更新和索引chart仓库。可用子命令：add、index、list、remove、update</td>
</tr>
<tr>
<td align="center">rollback</td>
<td align="left">从之前版本回滚</td>
</tr>
<tr>
<td align="center">search</td>
<td align="left">根据关键字搜索chart。可用子命令：hub、repo</td>
</tr>
<tr>
<td align="center">show</td>
<td align="left">查看chart详细信息。可用子命令：all、chart、readme、values</td>
</tr>
<tr>
<td align="center">status</td>
<td align="left">显示已命名版本的状态</td>
</tr>
<tr>
<td align="center">template</td>
<td align="left">本地呈现模板</td>
</tr>
<tr>
<td align="center">uninstall</td>
<td align="left">卸载一个release</td>
</tr>
<tr>
<td align="center">upgrade</td>
<td align="left">更新一个release</td>
</tr>
<tr>
<td align="center">version</td>
<td align="left">查看helm客户端版本</td>
</tr>
</tbody></table>
<h2 id="Helm-Chart模板"><a href="#Helm-Chart模板" class="headerlink" title="Helm-Chart模板"></a>Helm-Chart模板</h2><p>Helm最核心的就是模板，即模板化的K8S manifests文件。</p>
<p>它本质上就是一个Go的template模板。Helm在Go template模板的基础上，还会增加很多东西。如一些自定义的元数据信息、扩展的库以及一些类似于编程形式的工作流，例如条件语句、管道等等。这些东西都会使得我们的模板变得更加丰富。</p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>有了模板，我们怎么把我们自定义的配置融入进去呢？用的就是这个<code>values</code>文件。这两部分内容其实就是<code>chart</code>的核心功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 helm]<span class="comment"># helm create nginx</span></span><br><span class="line">Creating nginx</span><br><span class="line">[root@node001 helm]<span class="comment"># tree nginx/</span></span><br><span class="line">nginx/</span><br><span class="line">├── charts</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── hpa.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">│       └── test-connection.yaml</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Chart.yaml</code>用于描述这个 Chart的基本信息，包括名字、描述信息以及版本等。</li>
<li><code>values.yaml</code>用于存储 templates 目录中模板文件中用到变量的值。</li>
<li><code>Templates</code>目录里面存放所有yaml模板文件。</li>
<li><code>charts</code>目录里存放这个chart依赖的所有子chart。</li>
<li><code>NOTES.txt</code>用于介绍Chart帮助信息， helm install 部署后展示给用户。例如：如何使用这个 Chart、列出缺省的设置等。</li>
<li><code>_helpers.tpl</code>放置模板助手的地方，可以在整个 chart 中重复使用</li>
</ul>
<p>接下来尝试部署nginx应用，熟悉模板使用，先把templates 目录下面所有文件全部删除掉，这里我们自己来创建模板文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create deployment --image=nginx web --dry-run -o yaml &gt; templates/deployment.yaml</span></span><br><span class="line"><span class="comment"># kubectl expose deployment web --port=80 --target-port=80 --dry-run -o yaml &gt; templates/service.yaml</span></span><br><span class="line"></span><br><span class="line">[root@node001 helm]<span class="comment"># rm -rf mychart/templates/*</span></span><br><span class="line">[root@node001 helm]<span class="comment"># cd nginx/templates</span></span><br><span class="line">[root@node001 templates]<span class="comment"># ls</span></span><br><span class="line">deployment.yaml  service.yaml</span><br><span class="line">[root@node001 templates]<span class="comment"># cat *</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: web</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: web</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: web</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: web</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>实际上，这已经是一个可安装的Chart包了，通过 helm install命令来进行安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># helm install web nginx</span></span><br><span class="line">NAME: web</span><br><span class="line">LAST DEPLOYED: Fri Feb 11 15:35:54 2022</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br></pre></td></tr></table></figure>
<p>这样部署，其实与直接apply没什么两样。</p>
<p>然后使用如下命令可以看到实际的模板被渲染过后的资源文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># helm get manifest web</span></span><br></pre></td></tr></table></figure>
<p>可以看到，这与刚开始写的内容是一样的，包括名字、镜像等，我们希望能在一个地方统一定义这些会经常变换的字段，这就需要用到Chart的模板了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi templates/deployment.yaml </span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicas &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123; .Values.label &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: &#123;&#123; .Values.label &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image &#125;&#125;:&#123;&#123; .Values.imageTag &#125;&#125;</span><br><span class="line">        name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># vi templates/service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: &#123;&#123; .Values.label &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># vi values.yaml</span></span><br><span class="line">replicas: 2</span><br><span class="line">image: nginx</span><br><span class="line">imageTag: 1.17</span><br><span class="line">label: nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#尝试渲染</span></span><br><span class="line">[root@node001 nginx]<span class="comment"># helm install web --dry-run ./</span></span><br><span class="line">NAME: web</span><br><span class="line">LAST DEPLOYED: Fri Feb 11 16:04:18 2022</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Source: nginx/templates/service.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: nginx</span><br><span class="line">    app: web</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Source: nginx/templates/deployment.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: nginx</span><br><span class="line">    app: web</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.17</span><br><span class="line">        name: web</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-171.png" alt="access"></p>
<p>这个deployment就是一个Go template的模板，这里定义的Release模板对象属于Helm内置的一种对象，是从values文件中读取出来的。这样一来，我们可以将需要变化的地方都定义变量。</p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>Helm也提供了<code>--dry-run</code> <code>--debug</code>调试参数，帮助你验证模板正确性。在执行helm install时候带上这两个参数就可以把对应的values值和渲染的资源清单打印出来，而不会真正的去部署一个release。</p>
<p>比如我们来调试上面创建的 chart 包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># helm install web2 --dry-run /root/mychart</span></span><br></pre></td></tr></table></figure>
<h3 id="内置对象"><a href="#内置对象" class="headerlink" title="内置对象"></a>内置对象</h3><p>刚刚我们使用 <code>&#123;&#123;.Release.Name&#125;&#125;</code>将 release 的名称插入到模板中。这里的 <code>Release</code> 就是 Helm 的内置对象，下面是一些常用的内置对象：</p>
<table>
<thead>
<tr>
<th align="center">Release.Name</th>
<th align="left">release 名称</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Release.Name</td>
<td align="left">release 名称</td>
</tr>
<tr>
<td align="center">Release.Namespace</td>
<td align="left">release 命名空间</td>
</tr>
<tr>
<td align="center">Release.Service</td>
<td align="left">release 服务的名称</td>
</tr>
<tr>
<td align="center">Release.Revision</td>
<td align="left">release 修订版本号，从1开始累加</td>
</tr>
</tbody></table>
<p>参考文档: <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/chart_template_guide/builtin_objects/">https://helm.sh/zh/docs/chart_template_guide/builtin_objects/</a></p>
<h3 id="Values"><a href="#Values" class="headerlink" title="Values"></a>Values</h3><p>Values对象是为Chart模板提供值，这个对象的值有4个来源：</p>
<ul>
<li>chart 包中的 <code>values.yaml</code> 文件</li>
<li>父 chart 包的 <code>values.yaml</code> 文件</li>
<li>通过 <code>helm install</code> 或者 <code>helm upgrade</code> 的 <code>-f</code>或者 <code>--values</code>参数传入的自定义的 yaml 文件</li>
<li>通过 <code>--set</code> 参数传入的值</li>
</ul>
<p>chart 的 values.yaml 提供的值可以被用户提供的 values 文件覆盖，而该文件同样可以被 –set提供的参数所覆盖。</p>
<p>上面的例子中我们重新编辑了 <code>values.yaml</code> 文件，将默认的值全部清空，然后分别添加副本数、镜像名称、镜像版本、标签等</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi values.yaml</span></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">imageTag:</span> <span class="number">1.17</span></span><br><span class="line"><span class="attr">label:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<p>且values文件也可以包含结构化内容，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat values.yaml </span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">label:</span></span><br><span class="line">  <span class="attr">project:</span> <span class="string">ms</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment"># cat templates/deployment.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-deployment</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.Values.replicas</span> &#125;&#125; </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">project:</span> &#123;&#123; <span class="string">.Values.label.project</span> &#125;&#125;</span><br><span class="line">      <span class="attr">app:</span> &#123;&#123; <span class="string">.Values.label.app</span> &#125;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">project:</span> &#123;&#123; <span class="string">.Values.label.project</span> &#125;&#125;</span><br><span class="line">        <span class="attr">app:</span> &#123;&#123; <span class="string">.Values.label.app</span> &#125;&#125;</span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> &#123;&#123; <span class="string">.Values.image</span> &#125;&#125;<span class="string">:&#123;&#123;</span> <span class="string">.Values.imageTag</span> <span class="string">&#125;&#125;</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>参考文档: <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/chart_template_guide/values_files/">https://helm.sh/zh/docs/chart_template_guide/values_files/</a></p>
<h3 id="管道与函数"><a href="#管道与函数" class="headerlink" title="管道与函数"></a>管道与函数</h3><p>前面讲的模块，其实就是将值传给模板引擎进行渲染，模板引擎还支持对拿到数据进行二次处理。<br>例如从.Values中读取的值变成字符串，可以使用quote函数实现：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi templates/deployment.yaml</span></span><br><span class="line"><span class="attr">app:</span> &#123;&#123; <span class="string">quote</span> <span class="string">.Values.label.app</span> &#125;&#125;</span><br><span class="line"><span class="comment"># helm install --dry-run web ../mychart/ </span></span><br><span class="line">        <span class="attr">project:</span> <span class="string">ms</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">&quot;nginx&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>quote .Values.label.app</code> 将后面的值作为参数传递给quote函数。</p>
<p>模板函数调用语法为：<code>functionName arg1 arg2…</code></p>
<p>另外还会经常使用一个<code>default</code>函数，该函数允许在模板中指定默认值，以防止该值被忽略掉。<br>例如忘记定义，执行helm install 会因为缺少字段无法创建资源，这时就可以定义一个默认值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat values.yaml </span></span><br><span class="line">replicas: 2</span><br><span class="line"><span class="comment"># cat templates/deployment.yaml </span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;-deployment</span><br><span class="line">- name: &#123;&#123; .Values.name | default <span class="string">&quot;nginx&quot;</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>其他函数：<br>指定长度缩进：<code>&#123;&#123; .Values.resources | indent 12 &#125;&#125;</code><br>转大写：<code>&#123;&#123; upper .Values.resources &#125;&#125;</code><br>首字母大写：<code>&#123;&#123; title .Values.resources &#125;&#125;</code></p>
<p>参考文档: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/chart_template_guide/functions_and_pipelines/">https://helm.sh/zh/docs/chart_template_guide/functions_and_pipelines/</a></li>
<li><a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/chart_template_guide/function_list/">https://helm.sh/zh/docs/chart_template_guide/function_list/</a></li>
</ul>
<h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><h4 id="if-else"><a href="#if-else" class="headerlink" title="if/else"></a>if/else</h4><p>流程控制是为模板提供了一种能力，满足更复杂的数据逻辑处理。<br>Helm模板语言提供以下流程控制语句：</p>
<ul>
<li>if/else 条件块</li>
<li>with 指定范围</li>
<li>range 循环块</li>
<li>if</li>
</ul>
<p>if/else块是用于在模板中有条件地包含文本块的方法，条件块的基本结构如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">if</span> <span class="string">PIPELINE</span> &#125;&#125;</span><br><span class="line">  <span class="comment"># Do something</span></span><br><span class="line">&#123;&#123; <span class="string">else</span> <span class="string">if</span> <span class="string">OTHER</span> <span class="string">PIPELINE</span> &#125;&#125;</span><br><span class="line">  <span class="comment"># Do something else</span></span><br><span class="line">&#123;&#123; <span class="string">else</span> &#125;&#125;</span><br><span class="line">  <span class="comment"># Default case</span></span><br><span class="line">&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># cat values.yaml </span><br><span class="line">devops: k8</span><br><span class="line"></span><br><span class="line"># cat templates/deployment.yaml </span><br><span class="line">...</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">        &#123;&#123; if eq .Values.devops &quot;k8s&quot; &#125;&#125;</span><br><span class="line">        devops: 123</span><br><span class="line">        &#123;&#123; else &#125;&#125;</span><br><span class="line">        devops: 456</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>在上面条件语句使用了eq运算符判断是否相等，除此之外，还支持ne、 lt、 gt、 and、 or等运算符。</p>
<p>通过模板引擎来渲染一下，会得到如下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># helm install --dry-run web ../mychart/ </span><br><span class="line">...</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">        </span><br><span class="line">        devops: 456</span><br></pre></td></tr></table></figure>
<p>上面渲染出来会有多余的空行，这是因为当模板引擎运行时，会将控制指令删除，所有之前占的位置也就空白了，需要使用<code>&#123;&#123;- if …&#125;&#125;</code> 的方式消除此空行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat templates/deploymemt.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.env.hello</span> <span class="string">&quot;world&quot;</span> &#125;&#125;</span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">            <span class="attr">value:</span> <span class="number">123</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>现在是不是没有多余的空格了，如果使用-}}需谨慎，比如上面模板文件中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat templates/deploymemt.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">       <span class="attr">env:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.env.hello</span> <span class="string">&quot;world&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">           <span class="bullet">-</span> <span class="attr">hello:</span> <span class="literal">true</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>这会渲染成：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:- hello:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>因为<code>-&#125;&#125;</code>它删除了双方的换行符。</p>
<p>条件判断就是判断条件是否为真，如果值为以下几种情况则为false：</p>
<ul>
<li>一个布尔类型的 <code>假</code></li>
<li>一个数字 <code>零</code></li>
<li>一个 <code>空</code>的字符串</li>
<li>一个 <code>nil</code>（空或 <code>null</code>）</li>
<li>一个空的集合（ <code>map</code>、 <code>slice</code>、 <code>tuple</code>、 <code>dict</code>、 <code>array</code>）</li>
</ul>
<p>例如，判断一个空的数组</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat values.yaml </span></span><br><span class="line"><span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="comment"># limits:</span></span><br><span class="line">  <span class="comment">#   cpu: 100m</span></span><br><span class="line">  <span class="comment">#   memory: 128Mi</span></span><br><span class="line">  <span class="comment"># requests:</span></span><br><span class="line">  <span class="comment">#   cpu: 100m</span></span><br><span class="line">  <span class="comment">#   memory: 128Mi</span></span><br><span class="line"><span class="comment"># cat templates/deploymemt.yaml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.16</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.resources</span> &#125;&#125;</span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">&#123;&#123; <span class="string">toYaml</span> <span class="string">.Values.resources</span> <span class="string">|</span> <span class="string">indent</span> <span class="number">10</span> &#125;&#125;</span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>例如，判断一个布尔值</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat values.yaml </span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span> </span><br><span class="line">  <span class="attr">host:</span> <span class="string">example.ctnrs.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat templates/ingress.yaml </span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.ingress.enabled</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> &#123;&#123; <span class="string">.Values.ingress.host</span> &#125;&#125;</span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line">          <span class="attr">servicePort:</span> &#123;&#123; <span class="string">.Values.service.port</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="with"><a href="#with" class="headerlink" title="with"></a>with</h4><p>with: 控制变量作用域。<br>还记得之前我们的 <code>&#123;&#123;.Release.xxx&#125;&#125;</code>或者 <code>&#123;&#123;.Values.xxx&#125;&#125;</code>吗？其中的 <code>.</code>就是表示对当前范围的引用， .Values就是告诉模板在当前范围中查找 <code>Values</code>对象的值。而 with语句就可以来控制变量的作用域范围，其语法和一个简单的 if语句比较类似：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; with PIPELINE &#125;&#125;</span><br><span class="line">  #  restricted scope</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>with语句可以允许将当前范围 <code>.</code>设置为特定的对象，比如我们前面一直使用的 <code>.Values.label</code>，我们可以使用 with来将 <code>.</code>范围指向 <code>.Values.label</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat values.yaml </span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">label:</span></span><br><span class="line">  <span class="attr">project:</span> <span class="string">ms</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat templates/deployment.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.nodeSelector</span> &#125;&#125;</span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">team:</span> &#123;&#123; <span class="string">.team</span> &#125;&#125;</span><br><span class="line">        <span class="attr">gpu:</span> &#123;&#123; <span class="string">.gpu</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.16</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<p>优化后：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.nodeSelector</span> &#125;&#125;</span><br><span class="line"><span class="attr">nodeSelector:</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>上面增加了一个<code>&#123;&#123;- with .Values.label &#125;&#125; xxx &#123;&#123;- end &#125;&#125;</code>的一个块，这样的话就可以在当前的块里面直接引用 .team和 .gpu了。</p>
<p><code>with</code>是一个循环构造。使用<code>.Values.nodeSelector</code>中的值：将其转换为<code>Yaml</code>。toYaml之后的点是循环中<code>.Values.nodeSelector</code>的当前值</p>
<h4 id="range"><a href="#range" class="headerlink" title="range"></a>range</h4><p>在Helm模板语言中，使用 range关键字来进行循环操作, <code>values.yaml</code>文件中添加上一个变量列表:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat values.yaml </span></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>循环打印该列表:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">test:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  &#123;&#123;- range .Values.test &#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123; . &#125;&#125;</span></span><br><span class="line"><span class="string">  &#123;&#123;- end &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="comment"># helm install web --dry-run  .</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment"># Source: nginx/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">test:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    1</span></span><br><span class="line"><span class="string">    2</span></span><br><span class="line"><span class="string">    3</span></span><br><span class="line"><span class="string"></span><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>参考文档: <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/chart_template_guide/control_structures/">https://helm.sh/zh/docs/chart_template_guide/control_structures/</a></p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>变量，在模板中，使用变量的场合不多，但我们将看到如何使用它来简化代码，并更好地利用with和range。<br><strong>问题1：获取列表键值</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat ../values.yaml</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">NAME:</span> <span class="string">&quot;gateway&quot;</span></span><br><span class="line">  <span class="attr">JAVA_OPTS:</span> <span class="string">&quot;-Xmx1G&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># cat deployment.yaml </span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">		<span class="attr">env:</span></span><br><span class="line">		&#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$k</span>, <span class="string">$v</span> <span class="string">:=</span> <span class="string">.Values.env</span> &#125;&#125;</span><br><span class="line">           <span class="bullet">-</span> <span class="attr">name:</span> &#123;&#123; <span class="string">$k</span> &#125;&#125;</span><br><span class="line">             <span class="attr">value:</span> &#123;&#123; <span class="string">$v</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>渲染结果如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;-Xmx1G&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NAME</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;gateway&quot;</span></span><br></pre></td></tr></table></figure>
<p>上面在 range循环中使用 $key和 $value两个变量来接收后面列表循环的键和值。</p>
<p><strong>问题2：with中不能使用内置对象</strong><br>with语句块内不能再 .Release.Name对象，否则报错。我们可以将该对象赋值给一个变量可以来解决这个问题:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.Values.replicas</span> &#125;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">project:</span> &#123;&#123; <span class="string">.Values.label.project</span> &#125;&#125;</span><br><span class="line">        <span class="attr">app:</span> &#123;&#123; <span class="string">quote</span> <span class="string">.Values.label.app</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.label</span> &#125;&#125;</span><br><span class="line">        <span class="attr">project:</span> &#123;&#123; <span class="string">.project</span> &#125;&#125;</span><br><span class="line">        <span class="attr">app:</span> &#123;&#123; <span class="string">.app</span> &#125;&#125;</span><br><span class="line">        <span class="attr">release:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>上面会出错</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">$releaseName</span> <span class="string">:=</span> <span class="string">.Release.Name</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.label</span> &#125;&#125;</span><br><span class="line">  <span class="attr">project:</span> &#123;&#123; <span class="string">.project</span> &#125;&#125;</span><br><span class="line">  <span class="attr">app:</span> &#123;&#123; <span class="string">.app</span> &#125;&#125;</span><br><span class="line">  <span class="attr">release:</span> &#123;&#123; <span class="string">$releaseName</span> &#125;&#125;</span><br><span class="line">  <span class="comment"># 或者可以使用$符号,引入全局命名空间</span></span><br><span class="line">  <span class="attr">release:</span> &#123;&#123; <span class="string">$.Release.Name</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在 with语句上面增加了一句 <code>&#123;&#123;-$releaseName:=.Release.Name-&#125;&#125;</code>，其中 <code>$releaseName</code>就是后面的对象的一个引用变量，它的形式就是 <code>$name</code>，赋值操作使用 <code>:=</code>，这样 with语句块内部的 <code>$releaseName</code>变量仍然指向的是 <code>.Release.Name</code></p>
<p>参考文档: <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/chart_template_guide/variables/">https://helm.sh/zh/docs/chart_template_guide/variables/</a></p>
<h3 id="命名模板"><a href="#命名模板" class="headerlink" title="命名模板"></a>命名模板</h3><p>命名模板: 使用<code>define</code>定义，<code>template</code>引入，在<code>templates</code>目录中默认下划线_开头的文件为公共模板<code>_helpers.tpl</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat _helpers.tpl</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;demo.fullname&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">.Chart.Name</span> <span class="string">-</span>&#125;&#125;<span class="string">-&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat deployment.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">template</span> <span class="string">&quot;demo.fullname&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>template指令是将一个模板包含在另一个模板中的方法。但是，template函数不能用于Go模板管道。为了解决该问题，增加include功能。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat _helpers.tpl</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;demo.labels&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line"><span class="attr">app:</span> &#123;&#123; <span class="string">template</span> <span class="string">&quot;demo.fullname&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line"><span class="attr">chart:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Chart.Name &#125;&#125;</span>-<span class="template-variable">&#123;&#123; .Chart.Version &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="attr">release:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Release.Name &#125;&#125;</span>&quot;</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat deployment.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">include</span> <span class="string">&quot;demo.fullname&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    &#123;&#123;<span class="bullet">-</span> <span class="string">include</span> <span class="string">&quot;demo.labels&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">4</span> &#125;&#125;</span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>上面包含一个名为 <code>demo.labels</code> 的模板，然后将值 <code>.</code> 传递给模板，最后将该模板的输出传递给 <code>nindent</code> 函数。</p>
<p>参考文档: <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/chart_template_guide/named_templates/">https://helm.sh/zh/docs/chart_template_guide/named_templates/</a></p>
<h2 id="如何开发自己的Chart"><a href="#如何开发自己的Chart" class="headerlink" title="如何开发自己的Chart"></a>如何开发自己的Chart</h2><ol>
<li>先创建模板<code>helm create demo</code></li>
<li>修改<code>Chart.yaml</code>，<code>Values.yaml</code>，添加常用的变量</li>
<li>在templates目录下创建部署镜像所需要的yaml文件，并变量引用yaml里经常变动的字段</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info">k8s企业级DevOps实践-StatefulSet&amp;Helm v3</span></div><div class="post-copyright__url"><span class="post-copyright-info"><a id="post-url" href="https://cakepanit.com/forward/7139bb18.html">https://cakepanit.com/forward/7139bb18.html</a><a id="post-url-copy" title="复制文章链接" onclick="btf.copyFn(&quot;https://cakepanit.com/forward/7139bb18.html&quot;)"><i class="fas fa-paste copy-button"></i></a></span></div><div class="post-copyright__cc"><span class="post-copyright-info">转载前请阅读本站 <a href="/protocol/copyright/" title="本站所有原创文章采用知识共享(Creative Commons)署名—非商业性使用—相同方式共享4.0国际公共许可协议">版权协议</a>，文章著作权归 <a href="https://cakepanit.com">饼铛</a> 所有，转载请注明出处。</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OPS/">🌍OPS</a><a class="post-meta__tags" href="/tags/Zookeeper/">Zookeeper</a><a class="post-meta__tags" href="/tags/Kubernetes/">⛵Kubernetes</a><a class="post-meta__tags" href="/tags/StatefuSet/">StatefuSet</a><a class="post-meta__tags" href="/tags/Helm-v3/">Helm v3</a></div><div class="post_share"><div class="social-share" data-image="/images/pasted-146.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/DC9cYFtFic5G6JZgktjajza5fVfRJLaXLS.png" target="_blank"><img class="post-qr-code-img" src="/img/DC9cYFtFic5G6JZgktjajza5fVfRJLaXLS.png" alt="狗狗币(DogeCoin)"/></a><div class="post-qr-code-desc">狗狗币(DogeCoin)</div></li><li class="reward-item"><a href="/img/bc1q63xj5a3xgfulv8guate5qxmh6qh8ws7c3casqm.png" target="_blank"><img class="post-qr-code-img" src="/img/bc1q63xj5a3xgfulv8guate5qxmh6qh8ws7c3casqm.png" alt="比特币(BitCoin)"/></a><div class="post-qr-code-desc">比特币(BitCoin)</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/forward/29b0e6a9.html" title="Canal容器化&amp;Kubernetes部署"><img class="cover" src="/images/pasted-157.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Canal容器化&amp;Kubernetes部署</div><div class="content">
本文介绍Canal服务容器化+Kubernetes部署

参考文档:

https://github.com/alibaba/canal
https://github.com/kubernetes/kubernetes/issues/81450
https://hub.docker.com/r/canal/canal-server

什么是CanalCanal 是阿里巴巴的一个开源项目，基于java实现，整体已经在很多大型的互联网项目生产环境中使用，包括阿里、美团等都有广泛的应用，是一个非常成熟的数据库同步方案，基础的使用只需要进行简单的配置即可。

canal是通过模拟成为mysql 的slave的方式，监听mysql 的binlog日志来获取数据，binlog设置为row模式以后，不仅能获取到执行的每一个增删改的脚本，同时还能获取到修改前和修改后的数据。

基于这个特性，canal就能高性能的获取到mysql数据数据的变更。简而言之就是做MySQL数据异构的。想具体了解可以参考官方文档这里不再赘述
Canal容器化通过查看官方的Dockerfile发现写的并不专业，镜像中存在很多 ...</div></div></a></div><div class="next-post pull-right"><a href="/forward/2cfbf2d2.html" title="企业级OpenVPN搭建"><img class="cover" src="/images/pasted-141.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">企业级OpenVPN搭建</div><div class="content">引言
这篇文章其实是2019年年末记录的，当时是因为疫情原因公司需要协助员工在家办公。开发部门和总部安全部门认为直接吧公司内网系统开放访问不安全，一个一个给员工家里公网IP加白名单也不现实。就临危受命接下了搭建VPN的任务。这次将文档整理发出其实在纠结会不会被请去喝茶，毕竟话题敏感。希望人没事


PS:文档在记录时并没有太多中文参考资料，是自己摸索的，所以可能生成的有些证书并没有用上(多余的操作)。大家海涵

OpenVPN介绍
OpenVPN是一个用于创建虚拟专用网络加密通道的软件包，最早由James Yonan编写。OpenVPN允许创建的VPN使用公开密钥、电子证书、或者用户名／密码来进行身份验证。
它大量使用了OpenSSL加密库中的SSLv3/TLSv1协议函数库。
目前OpenVPN能在Solaris、Linux、OpenBSD、FreeBSD、NetBSD、Mac OS X与Microsoft Windows以及Android、iOS、MacOS(2020年官方推出Mac客户端)上运行，并包含了许多安全性的功能。它并不是一个基于Web的VPN软件，也不与IPsec及其他 ...</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/forward/29b0e6a9.html" title="Canal容器化&amp;Kubernetes部署"><img class="cover" src="/images/pasted-157.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-06</div><div class="title">Canal容器化&amp;Kubernetes部署</div><div class="info">
本文介绍Canal服务容器化+Kubernetes部署

参考文档:

https://github.com/alibaba/canal
https://github.com/kubernetes/kubernetes/issues/81450
https://hub.docker.com/r/canal/canal-server

什么是CanalCanal 是阿里巴巴的一个开源项目，基于java实现，整体已经在很多大型的互联网项目生产环境中使用，包括阿里、美团等都有广泛的应用，是一个非常成熟的数据库同步方案，基础的使用只需要进行简单的配置即可。

canal是通过模拟成为mysql 的slave的方式，监听mysql 的binlog日志来获取数据，binlog设置为row模式以后，不仅能获取到执行的每一个增删改的脚本，同时还能获取到修改前和修改后的数据。

基于这个特性，canal就能高性能的获取到mysql数据数据的变更。简而言之就是做MySQL数据异构的。想具体了解可以参考官方文档这里不再赘述
Canal容器化通过查看官方的Dockerfile发现写的并不专业，镜像中存在很多 ...</div></div></a></div><div><a href="/forward/7be7c575.html" title="Zookeeper-单节点与分布式"><img class="cover" src="/images/img-161.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-30</div><div class="title">Zookeeper-单节点与分布式</div><div class="info">
ZooKeeper是一个分布式开源框架，提供了协调分布式应用的基本服务，它向外部应用暴露一组通用服务——分布式同步（Distributed Synchronization）、命名服务（Naming Service）、集群维护（Group Maintenance）等，简化分布式应用协调及其管理的难度，提供高性能的分布式服务。ZooKeeper本身可以以Standalone模式安装运行，不过它的长处在于通过分布式ZooKeeper集群（一个Leader，多个Follower），基于一定的策略来保证ZooKeeper集群的稳定性和可用性，从而实现分布式应用的可靠性。

0.环境准备0.1规范目录1234567#root用户执行useradd hadoopmkdir -p /application/hadoop #zookeeper安装目录mkdir -p /data/zookeeper/zkdata #zookeeper数据目录mkdir -p /data/zookeeper/zklog #zookeeper日志目录chown -R hadoop.hadoop /application/h ...</div></div></a></div><div><a href="/forward/48a90e5c.html" title="gRPC程序健康检查&amp;Kubernetes部署&amp;负载均衡"><img class="cover" src="/images/pasted-167.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-11</div><div class="title">gRPC程序健康检查&amp;Kubernetes部署&amp;负载均衡</div><div class="info">
本文介绍gRPC程序健康检查+Kubernetes部署+负载均衡

参考文档:

https://github.com/grpc-ecosystem/grpc-health-probe
https://github.com/grpc/grpc/blob/v1.15.0/doc/health-checking.md
通过Ingress Controller实现gRPC服务访问 - 阿里云帮助中心
grpc - NGINX Ingress Controller
ngx_http_v2_module - NGINX
在 Kubernetes 上对 gRPC 服务器进行健康检查 - Kubernetes 博客
gRPC Load Balancing on Kubernetes without Tears - Kubernetes 博客
如何使用 Kong 管理您的 gRPC 服务 - KongHQ

健康检查相关我们都知道Kubernetes的健康检查（存活探针和就绪探针）可以使您的应用程序在睡眠时保持可用状态。当检测到没有回应的 Pod 时，会将其标记为不健康，并使这些 Pod 重新启动或 ...</div></div></a></div><div><a href="/forward/3ea5fff1.html" title="k8s企业级DevOps实践-Django应用容器化实践"><img class="cover" src="/images/pasted-6.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">k8s企业级DevOps实践-Django应用容器化实践</div><div class="info">django项目介绍
项目地址：https://gitee.com/pinchengx/pythondemo.git
python3 + uwsgi + nginx + mysql
内部服务端口8002


构建命令1$ docker build . -t ImageName:ImageTag -f Dockerfile

如何理解构建镜像的过程？
Dockerfile是一堆指令，在docker build的时候，按照该指令进行操作，最终生成我们期望的镜像

FROM 指定基础镜像，必须为第一个命令

  1234567格式：	FROM &lt;image&gt;	FROM &lt;image&gt;:&lt;tag&gt;示例：	FROM mysql:5.7注意：	tag是可选的，如果不使用tag时，会使用latest版本的基础镜像


MAINTAINER 镜像维护者的信息

  123456格式：	MAINTAINER &lt;name&gt;示例：	  MAINTAINER Yongxin Li    MAINTAINER inspur_lyx@hotmail.com    M ...</div></div></a></div><div><a href="/forward/2aa52898.html" title="k8s企业级DevOps实践-HPA容器的弹性伸缩"><img class="cover" src="/images/pasted-6.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-01</div><div class="title">k8s企业级DevOps实践-HPA容器的弹性伸缩</div><div class="info">HPA概述Horizontal Pod Autoscaler(HPA)是根据资源利用率或者自定义指标自动调整replication controller, Deployment 或 ReplicaSet，实现部署的水平自动扩缩容，让部署的规模接近于实际服务的负载。如果是DaemonSet这种无法缩放的对象，他是不支持的。
HPA控制原理K8s中的MetricsServer会持续采集Pod的指标数据，HPA 控制器通过 Metrics Server（需要提前安装） 的 API（Heapster 的 API 或聚合 API）获取集群中资源的使用状态，基于用户定义的扩缩容规则进行计算，得到目标 Pod 副本数量。当目标 Pod 副本数量与当前副本数量不同时，HPA 控制器就向 Pod 的副本控制器（Deployment、RC 或 ReplicaSet）发起 scale 操作，然后副本控制器会调整 Pod 的副本数量，完成扩缩容操作。

假设存在一个叫 A 的 Deployment，包含3个 Pod，每个副本的 Request 值是 1 核，当前 3 个 Pod 的 CPU 利用率分别是 60 ...</div></div></a></div><div><a href="/forward/55d102bd.html" title="k8s企业级DevOps实践-Kong的两种打开方式"><img class="cover" src="/images/pasted-84.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-16</div><div class="title">k8s企业级DevOps实践-Kong的两种打开方式</div><div class="info">概述KONG的核心对象为:upstream、target、service、route

upstream: 是对上游服务器的抽象；
target: 代表了一个物理服务，是 ip + port 的抽象；
service: 是抽象层面的服务，他可以直接映射到一个物理服务(host 指向 ip + port)，也可以指向一个upstream 来做到负载均衡；
route: 是路由的抽象，他负责将实际的 request 映射到 service。

KONG监听的端口为：8000、8001、8443、8444、8100

8444: 带ssl的管理端口
8000/8443: 分别是用来监听来自客户端的Http 和 Https请求，等价于 Nginx 默认的 80 端口
8001: 端口便是默认的管理端口，可以通过 HTTP Restful API 来动态管理 Kong 的配置
8100: 为prometheus获取metrics指标端口

案例Nginx Conf01:
12345678910upstream helloUpstream &#123;    server localhost:30 ...</div></div></a></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">饼铛</div><div class="author-info__description">寻找属于自己的彩虹海</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">95</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://t.me/joinchat/c_ParmoHMmU5MDM9" target="_blank" title="Telegram"><i class="fab fa-telegram-plane"></i></a><a class="social-icon" href="https://qm.qq.com/cgi-bin/qm/qr?k=Q1N9l3isk8O_i5awFwO-blAoPH7PUeb4&amp;noverify=0" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="mailto:admin@cakepanit.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=313775282" target="_blank" title="Netease"><i class="fas fa-record-vinyl"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-StatefulSet"><span class="toc-number">1.</span> <span class="toc-text">什么是 StatefulSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-PDB"><span class="toc-number">2.</span> <span class="toc-text">什么是 PDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Involuntary-AND-Voluntary"><span class="toc-number">2.1.</span> <span class="toc-text">Involuntary AND Voluntary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PDB-%E5%85%B3%E9%94%AE%E5%8F%82%E6%95%B0%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">2.2.</span> <span class="toc-text">PDB 关键参数与注意事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PDB-for-Zookeeper"><span class="toc-number">2.3.</span> <span class="toc-text">PDB for Zookeeper</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service%E5%92%8CDNS%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">3.</span> <span class="toc-text">Service和DNS的关系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ClusterIP-Service%E7%9A%84DNS%E5%88%86%E9%85%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">3.0.1.</span> <span class="toc-text">ClusterIP Service的DNS分配方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Headliness-Service%E7%9A%84DNS%E5%88%86%E9%85%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">3.0.2.</span> <span class="toc-text">Headliness Service的DNS分配方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-HeadLess"><span class="toc-number">4.</span> <span class="toc-text">什么是 HeadLess</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Normal%E5%92%8CHeadless%E5%AF%B9%E6%AF%94"><span class="toc-number">4.1.</span> <span class="toc-text">Normal和Headless对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">4.2.</span> <span class="toc-text">工作方式对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NormalService"><span class="toc-number">4.2.1.</span> <span class="toc-text">NormalService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HeadlessService"><span class="toc-number">4.2.2.</span> <span class="toc-text">HeadlessService</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HeadLess%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">4.3.</span> <span class="toc-text">HeadLess的作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zookeeper%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">Zookeeper容器化部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E6%8E%92PV%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="toc-number">5.1.</span> <span class="toc-text">编排PV持久化存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2Service-amp-PDB"><span class="toc-number">5.2.</span> <span class="toc-text">部署Service &amp; PDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2StatefulSet"><span class="toc-number">5.3.</span> <span class="toc-text">部署StatefulSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StatefulSet%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">StatefulSet总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFHelm"><span class="toc-number">7.</span> <span class="toc-text">什么是Helm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Helm-v3"><span class="toc-number">8.</span> <span class="toc-text">安装Helm v3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">9.</span> <span class="toc-text">Helm常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm-Chart%E6%A8%A1%E6%9D%BF"><span class="toc-number">10.</span> <span class="toc-text">Helm-Chart模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF"><span class="toc-number">10.1.</span> <span class="toc-text">模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">10.2.</span> <span class="toc-text">调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1"><span class="toc-number">10.3.</span> <span class="toc-text">内置对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Values"><span class="toc-number">10.4.</span> <span class="toc-text">Values</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E9%81%93%E4%B8%8E%E5%87%BD%E6%95%B0"><span class="toc-number">10.5.</span> <span class="toc-text">管道与函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-number">10.6.</span> <span class="toc-text">流程控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#if-else"><span class="toc-number">10.6.1.</span> <span class="toc-text">if&#x2F;else</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#with"><span class="toc-number">10.6.2.</span> <span class="toc-text">with</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#range"><span class="toc-number">10.6.3.</span> <span class="toc-text">range</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">10.7.</span> <span class="toc-text">变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E6%A8%A1%E6%9D%BF"><span class="toc-number">10.8.</span> <span class="toc-text">命名模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E8%87%AA%E5%B7%B1%E7%9A%84Chart"><span class="toc-number">11.</span> <span class="toc-text">如何开发自己的Chart</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/forward/f61b8e50.html" title="Golang-反射&amp;应用"><img src="/images/pasted-2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Golang-反射&amp;应用"/></a><div class="content"><a class="title" href="/forward/f61b8e50.html" title="Golang-反射&amp;应用">Golang-反射&amp;应用</a><time datetime="2023-03-17T18:48:00.000Z" title="发表于 2023-03-18 02:48:00">2023-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/forward/d4ac701.html" title="各公版系统修改锁定DNS"><img src="/images/pasted-288.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="各公版系统修改锁定DNS"/></a><div class="content"><a class="title" href="/forward/d4ac701.html" title="各公版系统修改锁定DNS">各公版系统修改锁定DNS</a><time datetime="2022-11-12T03:06:00.000Z" title="发表于 2022-11-12 11:06:00">2022-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/forward/1e56645c.html" title="Kong使用OAuth2.0 Plugin"><img src="/images/pasted-280.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kong使用OAuth2.0 Plugin"/></a><div class="content"><a class="title" href="/forward/1e56645c.html" title="Kong使用OAuth2.0 Plugin">Kong使用OAuth2.0 Plugin</a><time datetime="2022-09-03T10:10:00.000Z" title="发表于 2022-09-03 18:10:00">2022-09-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/forward/3df8560c.html" title="Terraform-基础设施即代码"><img src="/images/pasted-185.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Terraform-基础设施即代码"/></a><div class="content"><a class="title" href="/forward/3df8560c.html" title="Terraform-基础设施即代码">Terraform-基础设施即代码</a><time datetime="2022-07-12T14:29:00.000Z" title="发表于 2022-07-12 22:29:00">2022-07-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/forward/91db5a91.html" title="Apollo In Kubernetes（多数据中心）"><img src="/images/pasted-173.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Apollo In Kubernetes（多数据中心）"/></a><div class="content"><a class="title" href="/forward/91db5a91.html" title="Apollo In Kubernetes（多数据中心）">Apollo In Kubernetes（多数据中心）</a><time datetime="2022-04-04T00:00:00.000Z" title="发表于 2022-04-04 08:00:00">2022-04-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer-group-container"><div class="footer-group"><span class="footer-group-title">外链</span><a class="footer-group-item" target="_blank" rel="noopener" href="https://www.bilibili.com/">bilibili 弹幕网</a><a class="footer-group-item" target="_blank" rel="noopener" href="https://www.tiobe.com/tiobe-index/">编程语言排名</a><a class="footer-group-item" target="_blank" rel="noopener" href="https://www.submarinecablemap.com/">海底光缆分布</a><a class="footer-group-item" target="_blank" rel="noopener" href="https://cybermap.kaspersky.com/cn">网络威胁地图</a></div><div class="footer-group"><span class="footer-group-title">导航</span><a class="footer-group-item" href="/link/">友情链接</a><a class="footer-group-item" href="/tags/">全部标签</a><a class="footer-group-item" href="/charts/">文章统计</a><a class="footer-group-item" href="/bookshelf/">收藏书单</a></div><div class="footer-group"><span class="footer-group-title">分类</span><a class="footer-group-item" href="/categories/OPS/">运维教程</a><a class="footer-group-item" href="/categories/DBA/">DBA教程</a><a class="footer-group-item" href="/categories/Golang/">编码教程</a><a class="footer-group-item" href="/gallery/">收藏图库</a></div><div class="footer-group"><span class="footer-group-title">关于</span><a class="footer-group-item" href="/notice/">网站公告</a><a class="footer-group-item" href="/about/">关于本站</a><a class="footer-group-item" href="/status">站点监控</a><a class="footer-group-item" href="mailto:admin@cakepanit.com">联系博主</a></div><div class="footer-group" id="footer-group-flink"><span class="footer-group-title">友链<i class="fas fa-arrow-rotate-right" title="随机友链" onclick="eurkon.footerRandomFlink(flinks, 3);"></i></span><a class="footer-group-item" href="" target="_blank" rel="noopener external nofollow noreferrer">加载中...</a><a class="footer-group-item" href="" target="_blank" rel="noopener external nofollow noreferrer">加载中...</a><a class="footer-group-item" href="" target="_blank" rel="noopener external nofollow noreferrer">加载中...</a><a class="footer-group-item" href="/link/">更多友链</a></div><div class="footer-group"><span class="footer-group-title">协议</span><a class="footer-group-item" href="/protocol/comment/" title="用户发言前，请认真阅读本条例。一经发言，即视为同意接受本条例；如不同意，请勿发言。">评论协议</a><a class="footer-group-item" href="/protocol/copyright/" title="本站所有原创文章采用知识共享(Creative Commons)署名—非商业性使用—相同方式共享4.0国际公共许可协议">版权协议</a></div></div><div id="footer-banner"><div id="footer-banner-container"><div class="footer-banner"><div class="copyright">Copyright &copy; 2019 - 2023  Maxbit  All Rights Reserved.</div></div><div class="footer-banner"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">皖ICP备2021005605号-1</a><a target="_blank" rel="noopener" href="https://www.upyun.com/">UPYUN</a></div></div></div></div></footer></div><div class="hidden" id="rightside-mask" onclick="eurkon.switchRightSide();"></div><div class="hidden" id="rightside"><div id="rightside-header"><div id="rightside-back"><i class="fas fa-chevron-left" onclick="eurkon.backRightSide();"></i></div><div id="rightside-title">设置</div><div id="rightside-close" onclick="eurkon.switchRightSide();"><i class="fas fa-xmark"></i></div></div><div id="rightside-content"><div id="card-post-content"><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/DBA/"><span class="card-category-list-name">DBA</span><span class="card-category-list-count">34</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Golang/"><span class="card-category-list-name">Golang</span><span class="card-category-list-count">10</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/OPS/"><span class="card-category-list-name">OPS</span><span class="card-category-list-count">49</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a id="tags/Golang/" href="/tags/Golang/" style="font-size: 1.35em; color: rgb(24, 48, 197)">📝Golang<sup>10</sup></a><a id="tags/反射/" href="/tags/%E5%8F%8D%E5%B0%84/" style="font-size: 1.17em; color: rgb(135, 124, 75)">反射<sup>2</sup></a><a id="tags/reflect/" href="/tags/reflect/" style="font-size: 1.17em; color: rgb(55, 132, 114)">reflect<sup>2</sup></a><a id="tags/Git/" href="/tags/Git/" style="font-size: 1.22em; color: rgb(99, 70, 95)">Git<sup>4</sup></a><a id="tags/GitLab/" href="/tags/GitLab/" style="font-size: 1.22em; color: rgb(24, 90, 38)">GitLab<sup>4</sup></a><a id="tags/OPS/" href="/tags/OPS/" style="font-size: 1.45em; color: rgb(132, 178, 77)">🌍OPS<sup>49</sup></a><a id="tags/Docker/" href="/tags/Docker/" style="font-size: 1.27em; color: rgb(108, 160, 119)">Docker<sup>6</sup></a><a id="tags/Skywalking/" href="/tags/Skywalking/" style="font-size: 1.15em; color: rgb(136, 83, 46)">Skywalking<sup>1</sup></a><a id="tags/链路追踪/" href="/tags/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" style="font-size: 1.15em; color: rgb(63, 131, 5)">链路追踪<sup>1</sup></a><a id="tags/Download/" href="/tags/Download/" style="font-size: 1.15em; color: rgb(101, 89, 8)">⏬Download<sup>1</sup></a><a id="tags/ELK/" href="/tags/ELK/" style="font-size: 1.25em; color: rgb(163, 1, 139)">ELK<sup>5</sup></a><a id="tags/Logstash/" href="/tags/Logstash/" style="font-size: 1.17em; color: rgb(169, 138, 169)">Logstash<sup>2</sup></a><a id="tags/Nginx/" href="/tags/Nginx/" style="font-size: 1.17em; color: rgb(169, 129, 148)">Nginx<sup>2</sup></a><a id="tags/Kong/" href="/tags/Kong/" style="font-size: 1.2em; color: rgb(130, 107, 174)">Kong<sup>3</sup></a><a id="tags/OAuth2-0/" href="/tags/OAuth2-0/" style="font-size: 1.15em; color: rgb(30, 193, 71)">OAuth2.0<sup>1</sup></a><a id="tags/JumpServer/" href="/tags/JumpServer/" style="font-size: 1.15em; color: rgb(40, 149, 61)">JumpServer<sup>1</sup></a><a id="tags/堡垒机/" href="/tags/%E5%A0%A1%E5%9E%92%E6%9C%BA/" style="font-size: 1.15em; color: rgb(45, 165, 175)">堡垒机<sup>1</sup></a><a id="tags/iptables/" href="/tags/iptables/" style="font-size: 1.15em; color: rgb(58, 40, 117)">iptables<sup>1</sup></a><a id="tags/MongoDB/" href="/tags/MongoDB/" style="font-size: 1.2em; color: rgb(139, 198, 131)">MongoDB<sup>3</sup></a><a id="tags/NoSQL/" href="/tags/NoSQL/" style="font-size: 1.3em; color: rgb(23, 117, 145)">NoSQL<sup>7</sup></a><a id="tags/主从复制/" href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" style="font-size: 1.38em; color: rgb(177, 177, 158)">主从复制<sup>12</sup></a><a id="tags/MySQL/" href="/tags/MySQL/" style="font-size: 1.42em; color: rgb(190, 135, 5)">🌲MySQL<sup>26</sup></a><a id="tags/读写分离/" href="/tags/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" style="font-size: 1.22em; color: rgb(122, 166, 53)">读写分离<sup>4</sup></a><a id="tags/高可用/" href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/" style="font-size: 1.32em; color: rgb(173, 118, 81)">高可用<sup>8</sup></a><a id="tags/MHA/" href="/tags/MHA/" style="font-size: 1.17em; color: rgb(106, 60, 102)">MHA<sup>2</sup></a><a id="tags/分布式/" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 1.25em; color: rgb(184, 114, 14)">分布式<sup>5</sup></a><a id="tags/MyCAT/" href="/tags/MyCAT/" style="font-size: 1.2em; color: rgb(45, 163, 39)">MyCAT<sup>3</sup></a><a id="tags/垂直拆分/" href="/tags/%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86/" style="font-size: 1.15em; color: rgb(106, 33, 36)">垂直拆分<sup>1</sup></a><a id="tags/锁/" href="/tags/%E9%94%81/" style="font-size: 1.15em; color: rgb(116, 131, 54)">锁<sup>1</sup></a><a id="tags/ACID/" href="/tags/ACID/" style="font-size: 1.15em; color: rgb(195, 154, 2)">ACID<sup>1</sup></a><a id="tags/事务/" href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 1.15em; color: rgb(134, 22, 125)">事务<sup>1</sup></a><a id="tags/日志管理/" href="/tags/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/" style="font-size: 1.22em; color: rgb(122, 156, 98)">日志管理<sup>4</sup></a><a id="tags/SQL/" href="/tags/SQL/" style="font-size: 1.2em; color: rgb(44, 84, 172)">SQL<sup>3</sup></a><a id="tags/一致性hash算法/" href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7hash%E7%AE%97%E6%B3%95/" style="font-size: 1.15em; color: rgb(107, 54, 115)">一致性hash算法<sup>1</sup></a><a id="tags/PAM/" href="/tags/PAM/" style="font-size: 1.15em; color: rgb(55, 142, 82)">PAM<sup>1</sup></a><a id="tags/Ansible/" href="/tags/Ansible/" style="font-size: 1.15em; color: rgb(2, 50, 57)">Ansible<sup>1</sup></a><a id="tags/Playbook/" href="/tags/Playbook/" style="font-size: 1.15em; color: rgb(73, 178, 129)">Playbook<sup>1</sup></a><a id="tags/Redis/" href="/tags/Redis/" style="font-size: 1.25em; color: rgb(10, 34, 4)">Redis<sup>5</sup></a><a id="tags/tools/" href="/tags/tools/" style="font-size: 1.15em; color: rgb(176, 44, 40)">tools<sup>1</sup></a><a id="tags/SVN/" href="/tags/SVN/" style="font-size: 1.15em; color: rgb(97, 190, 162)">SVN<sup>1</sup></a><a id="tags/Zabbix/" href="/tags/Zabbix/" style="font-size: 1.22em; color: rgb(62, 114, 149)">Zabbix<sup>4</sup></a><a id="tags/Zookeeper/" href="/tags/Zookeeper/" style="font-size: 1.2em; color: rgb(40, 29, 52)">Zookeeper<sup>3</sup></a><a id="tags/gRPC/" href="/tags/gRPC/" style="font-size: 1.15em; color: rgb(10, 107, 94)">gRPC<sup>1</sup></a><a id="tags/Kubernetes/" href="/tags/Kubernetes/" style="font-size: 1.4em; color: rgb(110, 79, 86)">⛵Kubernetes<sup>20</sup></a><a id="tags/place/" href="/tags/place/" style="font-size: 1.15em; color: rgb(54, 28, 147)">place<sup>1</sup></a><a id="tags/mysql备份/" href="/tags/mysql%E5%A4%87%E4%BB%BD/" style="font-size: 1.15em; color: rgb(190, 99, 194)">mysql备份<sup>1</sup></a><a id="tags/弹性伸缩/" href="/tags/%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9/" style="font-size: 1.15em; color: rgb(120, 36, 77)">弹性伸缩<sup>1</sup></a><a id="tags/调度策略/" href="/tags/%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/" style="font-size: 1.15em; color: rgb(165, 2, 99)">调度策略<sup>1</sup></a><a id="tags/数据备份/" href="/tags/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD/" style="font-size: 1.17em; color: rgb(88, 37, 196)">数据备份<sup>2</sup></a><a id="tags/OPENVPN/" href="/tags/OPENVPN/" style="font-size: 1.15em; color: rgb(177, 189, 70)">OPENVPN<sup>1</sup></a><a id="tags/DNS/" href="/tags/DNS/" style="font-size: 1.15em; color: rgb(72, 115, 71)">DNS<sup>1</sup></a><a id="tags/树莓派/" href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 1.15em; color: rgb(64, 173, 143)">树莓派<sup>1</sup></a><a id="tags/Minecraft/" href="/tags/Minecraft/" style="font-size: 1.15em; color: rgb(77, 92, 35)">Minecraft<sup>1</sup></a><a id="tags/优化/" href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 1.15em; color: rgb(1, 144, 7)">优化<sup>1</sup></a><a id="tags/Apollo/" href="/tags/Apollo/" style="font-size: 1.15em; color: rgb(18, 121, 6)">Apollo<sup>1</sup></a><a id="tags/Canal/" href="/tags/Canal/" style="font-size: 1.15em; color: rgb(117, 11, 35)">Canal<sup>1</sup></a><a id="tags/多表联查/" href="/tags/%E5%A4%9A%E8%A1%A8%E8%81%94%E6%9F%A5/" style="font-size: 1.15em; color: rgb(106, 140, 122)">多表联查<sup>1</sup></a><a id="tags/CI-CD/" href="/tags/CI-CD/" style="font-size: 1.17em; color: rgb(29, 28, 155)">CI/CD<sup>2</sup></a><a id="tags/水平拆分/" href="/tags/%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86/" style="font-size: 1.15em; color: rgb(147, 107, 9)">水平拆分<sup>1</sup></a><a id="tags/索引/" href="/tags/%E7%B4%A2%E5%BC%95/" style="font-size: 1.15em; color: rgb(110, 168, 104)">索引<sup>1</sup></a><a id="tags/Redis哨兵/" href="/tags/Redis%E5%93%A8%E5%85%B5/" style="font-size: 1.15em; color: rgb(75, 42, 107)">Redis哨兵<sup>1</sup></a><a id="tags/Terraform/" href="/tags/Terraform/" style="font-size: 1.15em; color: rgb(10, 147, 107)">Terraform<sup>1</sup></a><a id="tags/基础设施即代码/" href="/tags/%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E5%8D%B3%E4%BB%A3%E7%A0%81/" style="font-size: 1.15em; color: rgb(51, 74, 63)">基础设施即代码<sup>1</sup></a><a id="tags/公有云编排/" href="/tags/%E5%85%AC%E6%9C%89%E4%BA%91%E7%BC%96%E6%8E%92/" style="font-size: 1.15em; color: rgb(99, 102, 129)">公有云编排<sup>1</sup></a><a id="tags/数据持久化/" href="/tags/%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/" style="font-size: 1.15em; color: rgb(189, 48, 177)">数据持久化<sup>1</sup></a><a id="tags/Workload/" href="/tags/Workload/" style="font-size: 1.15em; color: rgb(129, 174, 97)">Workload<sup>1</sup></a><a id="tags/服务发现/" href="/tags/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" style="font-size: 1.15em; color: rgb(22, 153, 137)">服务发现<sup>1</sup></a><a id="tags/数据库优化/" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96/" style="font-size: 1.15em; color: rgb(119, 181, 15)">数据库优化<sup>1</sup></a><a id="tags/容器编排/" href="/tags/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/" style="font-size: 1.15em; color: rgb(139, 4, 54)">容器编排<sup>1</sup></a><a id="tags/Prometheus/" href="/tags/Prometheus/" style="font-size: 1.15em; color: rgb(173, 108, 19)">Prometheus<sup>1</sup></a><a id="tags/StatefuSet/" href="/tags/StatefuSet/" style="font-size: 1.15em; color: rgb(189, 102, 58)">StatefuSet<sup>1</sup></a><a id="tags/Helm-v3/" href="/tags/Helm-v3/" style="font-size: 1.15em; color: rgb(157, 44, 15)">Helm v3<sup>1</sup></a><a id="tags/SHELL/" href="/tags/SHELL/" style="font-size: 1.15em; color: rgb(91, 195, 105)">SHELL<sup>1</sup></a><a id="tags/RAID/" href="/tags/RAID/" style="font-size: 1.15em; color: rgb(152, 109, 89)">RAID<sup>1</sup></a></div></div></div></div><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-sun"></i><i class="fas fa-moon"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="rightmenu"><div class="rightmenu-group rightmenu-small"><div class="rightmenu-item" id="menu-backward" onclick="window.history.back()"><i class="fas fa-arrow-left"></i></div><div class="rightmenu-item" id="menu-forward" onclick="window.history.forward()"><i class="fas fa-arrow-right"></i></div><div class="rightmenu-item" id="menu-refresh" onclick="window.history.reload()"><i class="fas fa-arrow-rotate-right"></i></div><div class="rightmenu-item" id="menu-top" onclick="btf.scrollToDest(0, 500)"><i class="fas fa-arrow-up"></i></div></div><div class="rightmenu-group rightmenu-line" id="rightmenu-text"><div class="rightmenu-item" id="menu-copy"><i class="fas fa-copy"></i><span>复制内容</span></div><div class="rightmenu-item" id="menu-comment"><i class="fas fa-comment"></i><span>引用评论</span></div><div class="rightmenu-item" id="menu-paste"><i class="fas fa-paste"></i><span>粘贴文本</span></div><div class="rightmenu-item" id="menu-search"><i class="fas fa-search"></i><span>在本站搜索</span></div><div class="rightmenu-item" id="menu-baidu"><i class="fas fa-search-plus"></i><span>去百度搜索</span></div></div><div class="rightmenu-group rightmenu-line" id="rightmenu-href"><div class="rightmenu-item" id="menu-copy-image"><i class="fas fa-copy"></i><span>复制图片</span></div><div class="rightmenu-item" id="menu-download-image"><i class="fas fa-download"></i><span>下载图片</span></div><div class="rightmenu-item" id="menu-link"><i class="fas fa-link"></i><span>分享链接</span></div><div class="rightmenu-item" id="menu-window"><i class="fas fa-window-restore"></i><span>新窗口打开</span></div></div><div class="rightmenu-group rightmenu-line" id="rightmenu-post"><a class="rightmenu-item" id="menu-random" href="/random/"><i class="fas fa-random"></i><span>随机文章</span></a><a class="rightmenu-item" id="menu-categories" href="/categories/"><i class="fas fa-shapes"></i><span>全部分类</span></a><a class="rightmenu-item" id="menu-tags" href="/tags/"><i class="fas fa-tags"></i><span>所有标签</span></a><div class="rightmenu-item" id="menu-share"><i class="fas fa-share-square"></i><span>分享本页</span></div></div><div class="rightmenu-group rightmenu-line" id="rightmenu-site"><a class="rightmenu-item" id="menu-message" href="/message/"><i class="fas fa-envelope"></i><span>留言信箱</span></a><a class="rightmenu-item" id="menu-about" href="/about/"><i class="fas fa-address-card"></i><span>关于本站</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/eurkon/color-thief.min.js"></script><script defer src="/js/eurkon/eurkon.js"></script><script defer data-pjax src="/js/eurkon/refresh.js"></script><script src="/js/tw_cn.js"></script><script src="/css/fei/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer data-pjax async src="//at.alicdn.com/t/font_2358265_expoyqe85d4.js"></script><script src="/css/fei/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/haru01.model.json"},"bottom":-40,"display":{"position":"right","width":190,"height":380,"hOffset":5},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html><script>var posts=["forward/60c1bc2d.html","forward/408a4bb8.html","forward/882d9505.html","forward/d063782.html","forward/download.html","forward/17b35260.html","forward/131c756.html","forward/47eea66c.html","forward/eb065b59.html","forward/873540ab.html","forward/d12df344.html","forward/f61b8e50.html","forward/43472028.html","forward/8f91bfec.html","forward/d5b63f7f.html","forward/420acb0d.html","forward/f9d199b7.html","forward/1e56645c.html","forward/bac240f7.html","forward/d7240237.html","forward/c4bb5371.html","forward/6c0d75ae.html","forward/3053135c.html","forward/74c8159a.html","forward/bbb9c58b.html","forward/c919a25c.html","forward/557ea64b.html","forward/49de8711.html","forward/f34e607d.html","forward/c3e1b71a.html","forward/bc8a646.html","forward/93ea067.html","forward/62bf20bb.html","forward/cb26d424.html","forward/3c4a0863.html","forward/ddc093b3.html","forward/4f3d60c1.html","forward/a7fae6f0.html","forward/ae362167.html","forward/36cbf320.html","forward/67af6371.html","forward/fb94f251.html","forward/212d60e3.html","forward/b571ca78.html","forward/fabc6ce1.html","forward/ae26d423.html","forward/f353577b.html","forward/2f09977b.html","forward/3837938a.html","forward/7be7c575.html","forward/48a90e5c.html","forward/4a17b156.html","forward/5234d9e2.html","forward/3ea5fff1.html","forward/2aa52898.html","forward/55d102bd.html","forward/ad8d3f77.html","forward/1758bdeb.html","forward/6cfd7a23.html","forward/8cd3cd17.html","forward/8e9bbd7d.html","forward/2cfbf2d2.html","forward/d4ac701.html","forward/8bd2a16a.html","forward/d6f16b84.html","forward/91db5a91.html","forward/29b0e6a9.html","forward/d36764c1.html","forward/852a3e1.html","forward/13c392b.html","forward/40c70ce.html","forward/c3e55136.html","forward/84c0fcc7.html","forward/69e1266e.html","forward/663d93c2.html","forward/68023dec.html","forward/da64184b.html","forward/ae6c7518.html","forward/3df8560c.html","forward/b36ee5af.html","forward/1051b489.html","forward/dc57d8c4.html","forward/61316209.html","forward/503970b4.html","forward/ff7280bd.html","forward/b17eefd4.html","forward/5c41384a.html","forward/14a32ee2.html","forward/58eea07e.html","forward/6b4e4d76.html","forward/dc57d8c5.html","forward/7139bb18.html","forward/649a95fd.html","forward/57e2aa11.html","forward/312ec9e0.html"];function toRandomPost(){ window.pjax ? pjax.loadUrl('/'+posts[Math.floor(Math.random()*posts.length)]) : window.open('/'+posts[Math.floor(Math.random()*posts.length)], "_self"); };</script><script>var flinks=[{"name":"Eurkon","link":"https://blog.eurkon.com","avatar":"https://blog.eurkon.com/images/user/avatar.jpg","descr":"不只是代码的搬运工"},{"name":"一朵大呲花","link":"https://www.iiemo.com/","avatar":"https://www.iiemo.com/logo.png","descr":"资深NB前端大佬"},{"name":"豌豆多多","link":"https://wandouduoduo.github.io/","avatar":"/img/link/index.png","descr":"资深沪漂运维工程师"},{"name":"周小雨","link":"https://zxyy.me/","avatar":"https://q2.qlogo.cn/headimg_dl?dst_uin=1016673080&spec=100","descr":"PHP程序猿"},{"name":"ACG食堂","link":"https://canteen.globalacca.top/","avatar":"https://q2.qlogo.cn/headimg_dl?dst_uin=1478030465&spec=100","descr":"汇集ACG、动漫和galgame为一体的综合小站"},{"name":"缺缺","link":"https://www.quewaner.com/","avatar":"https://q2.qlogo.cn/headimg_dl?dst_uin=3393597524&spec=100","descr":"资深前端工程师"},{"name":"yiyun","link":"https://moeci.com/","avatar":"https://q2.qlogo.cn/headimg_dl?dst_uin=2284407619&spec=100","descr":"全栈开发"},{"name":"二哈小窝","link":"https://www.moeeh.cn/","avatar":"https://www.moeeh.cn/eh/eh.png","descr":"苦酒折柳今相离 无风无月也无你"},{"name":"Akilarの糖果屋","link":"https://akilar.top/","avatar":"https://unpkg.zhimg.com/akilar-candyassets/image/siteicon/favicon.png","descr":"期待您的光临！"},{"name":"小高导航","link":"https://www.dhw22.com/","avatar":"https://www.dhw22.com/wp-content/uploads/2022/01/Favicon.png","descr":"资源类技术教程活动导航分类平台"},{"name":"华为开源镜像站","link":"https://mirrors.huaweicloud.com/","avatar":"/img/link/huawei.png","descr":"构建万物互联的智能世界"},{"name":"阿里开源镜像站","link":"https://mirrors.aliyun.com/","avatar":"/img/link/aliyun.png","descr":"为了无法计算的价值"},{"name":"网易开源镜像站","link":"https://mirrors.163.com/","avatar":"/img/link/netease.png","descr":"网聚人的力量"},{"name":"搜狐开源镜像站","link":"https://mirrors.sohu.com/","avatar":"/img/link/souhu.png","descr":"上搜狐 知天下"},{"name":"清华开源镜像站","link":"https://mirrors.tuna.tsinghua.edu.cn/","avatar":"/img/link/qh.png","descr":"自强不息,厚德载物"},{"name":"浙大开源镜像站","link":"https://mirrors.zju.edu.cn/","avatar":"/img/link/zd.png","descr":"兼总条贯,知至知终"},{"name":"中科大开源镜像站","link":"https://mirrors.ustc.edu.cn/","avatar":"/img/link/zkd.png","descr":"红专并进,理实交融"},{"name":"兰大开源镜像站","link":"https://mirror.lzu.edu.cn/","avatar":"/img/link/ld.png","descr":"独树一帜,自强不息"}];function toRandomFlink(){window.open(flinks[Math.floor(Math.random()*flinks.length)].link);};</script>