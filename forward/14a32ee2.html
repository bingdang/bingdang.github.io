<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MySQL终章-系列优化 | Maxbit</title><meta name="keywords" content="MySQL,数据库优化"><meta name="author" content="饼铛"><meta name="copyright" content="饼铛"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="0.环境准备：1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859准备100w行数据包，留作压力测试。db03 [(none)]&gt;create database oldboy;Query OK, 1 row affected (">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL终章-系列优化">
<meta property="og:url" content="https://cakepanit.com/forward/14a32ee2.html">
<meta property="og:site_name" content="Maxbit">
<meta property="og:description" content="0.环境准备：1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859准备100w行数据包，留作压力测试。db03 [(none)]&gt;create database oldboy;Query OK, 1 row affected (">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cakepanit.com/images/img-71.png">
<meta property="article:published_time" content="2020-05-05T11:27:00.000Z">
<meta property="article:modified_time" content="2021-08-02T01:48:36.846Z">
<meta property="article:author" content="饼铛">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="数据库优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cakepanit.com/images/img-71.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://cakepanit.com/forward/14a32ee2"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":200,"languages":{"author":"作者: 饼铛","link":"链接: ","source":"来源: Maxbit","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL终章-系列优化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-08-02 09:48:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.css"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-file-image"></i><span> Gallery</span></a></li><li><a class="site-page child" href="/status"><i class="fa-fw fab fa-accessible-icon"></i><span> Status</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/img-71.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Maxbit</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-file-image"></i><span> Gallery</span></a></li><li><a class="site-page child" href="/status"><i class="fa-fw fab fa-accessible-icon"></i><span> Status</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL终章-系列优化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-05T11:27:00.000Z" title="发表于 2020-05-05 19:27:00">2020-05-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-08-02T01:48:36.846Z" title="更新于 2021-08-02 09:48:36">2021-08-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DBA/">DBA</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>36分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL终章-系列优化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="0-环境准备："><a href="#0-环境准备：" class="headerlink" title="0.环境准备："></a>0.环境准备：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">准备100w行数据包，留作压力测试。</span><br><span class="line">db03 [(none)]&gt;create database oldboy;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">db03 [(none)]&gt;use oldboy;</span><br><span class="line">Database changed</span><br><span class="line">db03 [oldboy]&gt;create table t100w (</span><br><span class="line">    -&gt; id int,num int,</span><br><span class="line">    -&gt; k1 char(2),</span><br><span class="line">    -&gt; k2 char(4),</span><br><span class="line">    -&gt; dt timestamp) charset utf8mb4 collate utf8mb4_bin;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">db03 [oldboy]&gt;delimiter //</span><br><span class="line">db03 [oldboy]&gt;create  procedure rand_data(<span class="keyword">in</span> num int)</span><br><span class="line">    -&gt; begin</span><br><span class="line">    -&gt; <span class="built_in">declare</span> str char(62) default <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    -&gt; <span class="built_in">declare</span> str2 char(2);</span><br><span class="line">    -&gt; <span class="built_in">declare</span> str4 char(4);</span><br><span class="line">    -&gt; <span class="built_in">declare</span> i int default 0;</span><br><span class="line">    -&gt; <span class="keyword">while</span> i&lt;num <span class="keyword">do</span></span><br><span class="line">    -&gt; <span class="built_in">set</span> str2=concat(substring(str,1+floor(rand()*61),1),substring(str,1+floor(rand()*61),1));</span><br><span class="line">    -&gt; <span class="built_in">set</span> str4=concat(substring(str,1+floor(rand()*61),2),substring(str,1+floor(rand()*61),2));</span><br><span class="line">    -&gt; <span class="built_in">set</span> i=i+1;</span><br><span class="line">    -&gt; insert into t100w values (i,floor(rand()*num),str2,str4,now());</span><br><span class="line">    -&gt; end <span class="keyword">while</span>;</span><br><span class="line">    -&gt; end;</span><br><span class="line">    -&gt; //</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">db03 [oldboy]&gt;delimiter ;</span><br><span class="line">db03 [oldboy]&gt;call rand_data(1000000);</span><br><span class="line">Query OK, 1 row affected (26.40 sec)</span><br><span class="line"></span><br><span class="line">测试：</span><br><span class="line">[root@db03 ~]<span class="comment"># mysqlslap --defaults-file=/etc/my.cnf --socket /tmp/mysql.sock \</span></span><br><span class="line">&gt; --concurrency=100 --iterations=1 --create-schema=<span class="string">&#x27;oldboy&#x27;</span> \</span><br><span class="line">&gt; --query=<span class="string">&quot;select * from oldboy.t100w where k2=&#x27;GHvw&#x27;&quot;</span> engine=innodb \</span><br><span class="line">&gt; --number-of-queries=2000 -verbose</span><br><span class="line">Benchmark</span><br><span class="line">        Running <span class="keyword">for</span> engine rbose</span><br><span class="line">        Average number of seconds to run all queries: 191.950 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 191.950 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 191.950 seconds</span><br><span class="line">        Number of clients running queries: 100</span><br><span class="line">        Average number of queries per client: 20</span><br><span class="line">//191秒</span><br><span class="line"></span><br><span class="line">[root@db03 ~]<span class="comment"># mysqlslap --defaults-file=/etc/my.cnf --socket /tmp/mysql.sock --concurrency=1000 --iterations=1 --create-schema=&#x27;oldboy&#x27; --query=&quot;select * from oldboy.t100w where k2=&#x27;GHvw&#x27;&quot; engine=innodb --number-of-queries=20000 -verbose</span></span><br><span class="line">mysqlslap: Error when connecting to server: 2000 Unknown MySQL error</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//并发连接数改为1000，报错</span><br><span class="line">top:</span><br><span class="line">Tasks: 117 total,   1 running, 116 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  : 99.7 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.3 si,  0.0 st</span><br><span class="line">%Cpu1  :100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu2  :100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu3  : 99.7 us,  0.3 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br></pre></td></tr></table></figure>

<h2 id="1-优化范围："><a href="#1-优化范围：" class="headerlink" title="1.优化范围："></a>1.优化范围：</h2><ul>
<li>存储、主机和操作系统:<ul>
<li>主机架构稳定性</li>
<li>I/O规划及配置</li>
<li>Swap</li>
<li>OS内核参数</li>
<li>网络问题</li>
</ul>
</li>
<li>应用程序:（Index，lock，session）<ul>
<li>应用程序稳定性和性能</li>
<li>SQL语句性能</li>
<li>串行访问资源</li>
<li>性能欠佳会话管理</li>
</ul>
</li>
<li>数据库优化:（内存、数据库设计、参数）<ul>
<li>内存</li>
<li>数据库结构(物理&amp;逻辑)</li>
<li>实例配置</li>
</ul>
</li>
<li>架构设计 :  <ul>
<li>性能  : 读写分离,分布式</li>
<li>安全  : 主备,多活</li>
<li>安全&amp;性能 : 分布式,NewSQL</li>
</ul>
</li>
</ul>
<p><img src="/images/img-98.png" alt="优化"></p>
<h2 id="2-操作系统层面优化工具介绍"><a href="#2-操作系统层面优化工具介绍" class="headerlink" title="2.操作系统层面优化工具介绍"></a>2.操作系统层面优化工具介绍</h2><h3 id="2-1top"><a href="#2-1top" class="headerlink" title="2.1top"></a>2.1top</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">CPU：</span><br><span class="line">%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :  3880016 total,  3699388 free,   102612 used,    78016 buff/cache</span><br><span class="line">KiB Swap:  2097148 total,  2097148 free,        0 used.  3615864 avail Mem</span><br><span class="line"></span><br><span class="line">按1键展开</span><br><span class="line">%Cpu0  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu1  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu2  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu3  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">id 空闲的CPU时间片占比</span><br><span class="line"></span><br><span class="line">wa CPU用来等待的时间片占比</span><br><span class="line">    等待IO：全表扫描 </span><br><span class="line">    等待大的处理事件</span><br><span class="line">    锁</span><br><span class="line"></span><br><span class="line">us 用户程序工作所占有的时间片占比</span><br><span class="line"></span><br><span class="line">sy 内核工作花费的CPU时间片占比</span><br><span class="line">    bug，中病毒 </span><br><span class="line">    各种资源的调度和分配</span><br><span class="line">    高并发连接</span><br><span class="line">    锁</span><br><span class="line"></span><br><span class="line">%CPU 如果出现%过高的情况，属于正常现象。多核利用率的总和</span><br><span class="line"></span><br><span class="line">内存：</span><br><span class="line">KiB Mem :  3880016 total,  3479320 free,   281328 used,   119368 buff/cache</span><br><span class="line">KiB Swap:  2097148 total,  2097148 free,        0 used.  3416472 avail Mem </span><br><span class="line"></span><br><span class="line">3416472 avail Mem //操作系统层面可用容量</span><br><span class="line"></span><br><span class="line">swap：</span><br><span class="line">Linux 6操作系统，默认回收策略（buffer cache），不立即回收策略</span><br><span class="line">内存使用达到100%-60%时候，40% 会使用swap</span><br><span class="line"></span><br><span class="line">Linux 7操作系统</span><br><span class="line">内存使用达到100%-30%（70%）时候，才会时候swap</span><br><span class="line">cat /proc/sys/vm/swappiness </span><br><span class="line">30  </span><br><span class="line"><span class="built_in">echo</span> 0 &gt;/proc/sys/vm/swappiness    的内容改成0（临时）</span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line">添加:</span><br><span class="line">vm.swappiness=0 //此参数告诉系统，在内存不够用时。使用内存回收机制解决，而不是倾向于使用swap</span><br><span class="line">sysctl -p </span><br></pre></td></tr></table></figure>
<h3 id="2-2iostat"><a href="#2-2iostat" class="headerlink" title="2.2iostat"></a>2.2iostat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">yum install -y sysstat</span><br><span class="line">[root@db03 ~]<span class="comment"># df -Th</span></span><br><span class="line">文件系统                类型      容量  已用  可用 已用% 挂载点</span><br><span class="line">/dev/sdb1               xfs       5.0G  166M  4.9G    4% /data</span><br><span class="line"></span><br><span class="line">[root@db03 ~]<span class="comment"># iostat -dk 1 //每秒实时读写性能 kb为单位</span></span><br><span class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">sdb               0.00         0.00         0.00          0          0</span><br><span class="line">sda               0.00         0.00         0.00          0          0</span><br><span class="line">dm-0              0.00         0.00         0.00          0          0</span><br><span class="line"></span><br><span class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">sdb               0.00         0.00         0.00          0          0</span><br><span class="line">sda               0.00         0.00         0.00          0          0</span><br><span class="line">dm-0              0.00         0.00         0.00          0          0</span><br><span class="line"></span><br><span class="line">[root@db03 ~]<span class="comment"># dd if=/dev/zero of=/data/bigfile bs=1M count=2048 //持续写入判断当前硬盘io吞吐量</span></span><br><span class="line">记录了2048+0 的读入</span><br><span class="line">记录了2048+0 的写出</span><br><span class="line">2147483648字节(2.1 GB)已复制，4.08114 秒，526 MB/秒</span><br></pre></td></tr></table></figure>
<h3 id="2-3综合判断"><a href="#2-3综合判断" class="headerlink" title="2.3综合判断"></a>2.3综合判断</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">一般情况下，CPU高，IO也应该高。</span><br><span class="line">如果：CPU 高   ，IO 比较低</span><br><span class="line"><span class="built_in">wait</span> 高：  有可以能IO出问题了（Raid损坏,过度条带化）</span><br><span class="line">SyS  高：  有可能是锁的问题，需要进一步去数据库中判断</span><br></pre></td></tr></table></figure>
<h3 id="2-4vmstat"><a href="#2-4vmstat" class="headerlink" title="2.4vmstat"></a>2.4vmstat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@db03 ~]<span class="comment"># vmstat 1 //综合探测，内存，swap，io，system，cpu实时指标</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 1  0      0 1302256   5208 2284188    0    0     5    88   16   29  0  0 100  0  0</span><br><span class="line"> 0  0      0 1302208   5208 2284188    0    0     0     4   56   67  0  0 100  0  0</span><br><span class="line"> 0  0      0 1302264   5208 2284188    0    0     0     0   31   56  0  0 100  0  0</span><br><span class="line"> 0  0      0 1302264   5208 2284188    0    0     0     0   32   66  0  0 100  0  0</span><br><span class="line"> 0  0      0 1302264   5208 2284188    0    0     0     0   25   53  0  0 100  0  0</span><br></pre></td></tr></table></figure>
<h2 id="3-数据库优化工具介绍"><a href="#3-数据库优化工具介绍" class="headerlink" title="3.数据库优化工具介绍"></a>3.数据库优化工具介绍</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    show status  </span><br><span class="line">    show variables </span><br><span class="line">    show index  </span><br><span class="line">    show processlist </span><br><span class="line">    show slave status</span><br><span class="line">    show engine innodb status </span><br><span class="line">    desc /explain </span><br><span class="line">    slowlog</span><br><span class="line">扩展类深度优化:</span><br><span class="line">    pt系列（pt-query-digest pt-osc pt-index 等）</span><br><span class="line">    mysqlslap </span><br><span class="line">    sysbench </span><br><span class="line">    information_schema （I_S）</span><br><span class="line">    performance_schema (P_S)</span><br><span class="line">    sys </span><br></pre></td></tr></table></figure>

<h2 id="4-优化思路分解"><a href="#4-优化思路分解" class="headerlink" title="4.优化思路分解"></a>4.优化思路分解</h2><h3 id="4-1-硬件优化"><a href="#4-1-硬件优化" class="headerlink" title="4.1 硬件优化"></a>4.1 硬件优化</h3><h4 id="4-1-1主机"><a href="#4-1-1主机" class="headerlink" title="4.1.1主机"></a>4.1.1主机</h4><ul>
<li><strong>真实的硬件（PC Server）</strong>：<ul>
<li>DELL  R系列 </li>
<li>华为</li>
<li>浪潮</li>
<li>HP</li>
<li>联想</li>
</ul>
</li>
<li><strong>云产品</strong>：<ul>
<li>ECS</li>
<li>数据库RDS</li>
<li>DRDS</li>
<li>polarDB</li>
</ul>
</li>
</ul>
<p><strong>IBM 小型机</strong> P6  570  595   P7 720  750 780     P8 </p>
<ul>
<li><strong>CPU根据数据库类型</strong><ul>
<li>OLTP  //在线事务处理</li>
<li>OLAP  //查询类很多，仓库类</li>
</ul>
</li>
</ul>
<p><strong>业务类型：</strong><br><strong>IO密集型</strong>：线上系统，OLTP主要是IO密集型的业务，高并发<br><strong>CPU密集型</strong>：数据分析数据处理，OLAP，cpu密集型的，需要CPU高计算能力（i系列，IBM power系列）</p>
<p><strong>根据业务选型：</strong><br><strong>CPU密集型</strong>： I 系列的，主频很高，核心少<br><strong>IO密集型</strong>：  E系列（至强），主频相对低，核心数量多</p>
<h4 id="4-1-2内存"><a href="#4-1-2内存" class="headerlink" title="4.1.2内存"></a>4.1.2内存</h4><p>建议2-3倍cpu核心数量 （ECC版）</p>
<h4 id="4-1-3磁盘选择"><a href="#4-1-3磁盘选择" class="headerlink" title="4.1.3磁盘选择"></a>4.1.3磁盘选择</h4><ul>
<li>SATA-III&lt;SAS&lt;Fc(光纤盘)&lt;SSD（sata）&lt;pci-e ssd&lt;Flash</li>
<li>主机 RAID卡的BBU主机备用电池单元(Battery Backup Unit)关闭</li>
</ul>
<h4 id="4-1-4存储"><a href="#4-1-4存储" class="headerlink" title="4.1.4存储"></a>4.1.4存储</h4><p>根据存储数据种类的不同，选择不同的存储设备<br>配置合理的RAID级别(raid5、raid10、热备盘)   </p>
<ul>
<li>r0 :条带化 ,性能高</li>
<li>r1 :镜像，安全</li>
<li>r5 :校验+条带化，安全较高+性能较高（读），写性能较低 （适合于读多写少）</li>
<li>r10：安全+性能都很高，最少四块盘，浪费一半的空间（高IO要求）</li>
</ul>
<h4 id="4-1-5网络"><a href="#4-1-5网络" class="headerlink" title="4.1.5网络"></a>4.1.5网络</h4><ul>
<li>1、硬件买好的（单卡单口）</li>
<li>2、网卡绑定（bonding），交换机堆叠</li>
</ul>
<p>以上问题，提前规避掉。</p>
<h2 id="5-操作系统优化"><a href="#5-操作系统优化" class="headerlink" title="5.操作系统优化"></a>5.操作系统优化</h2><h3 id="5-1Swap调整"><a href="#5-1Swap调整" class="headerlink" title="5.1Swap调整"></a>5.1Swap调整</h3><p><code>echo 0 &gt;/proc/sys/vm/swappiness</code>的内容改成0（临时），<br><code>vim /etc/sysctl.conf</code><br>上添加<code>vm.swappiness=0</code>（永久）<br><code>sysctl -p</code><br>这个参数决定了Linux是倾向于使用swap，还是倾向于释放文件系统cache。在内存紧张的情况下，数值越低越倾向于释放文件系统cache。<br>当然，这个参数只能减少使用swap的概率，并不能避免Linux使用swap。</p>
<p>修改MySQL的配置参数<code>innodb_flush_method，开启O_DIRECT</code>模式<br>这种情况下，InnoDB的<code>buffer pool</code>会直接绕过文件系统cache来访问磁盘，但是<code>redo log</code>依旧会使用文件系统cache。值得注意的是，Redo log是覆写模式的，即使使用了文件系统的cache，也不会占用太多</p>
<p>IO调度策略<br>centos 7 默认是deadline<br><code>cat   /sys/block/sda/queue/scheduler</code></p>
<p>#临时修改为deadline(centos6)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> deadline &gt;/sys/block/sda/queue/scheduler </span><br><span class="line">vi /boot/grub/grub.conf</span><br></pre></td></tr></table></figure>
<p>更改到如下内容:<br><code>kernel /boot/vmlinuz-2.6.18-8.el5 ro root=LABEL=/ elevator=deadline rhgb quiet</code></p>
<p>IO ：</p>
<ul>
<li>raid</li>
<li>no lvm<code>安全性</code></li>
<li>ext4或xfs<code>并发高</code></li>
<li>ssd</li>
<li>IO调度策略<br>提前规划好以上所有问题，减轻MySQL优化的难度。</li>
</ul>
<h2 id="6-应用端"><a href="#6-应用端" class="headerlink" title="6.应用端"></a>6.应用端</h2><ol>
<li>开发过程规范,标准。做好审核。</li>
<li>减少烂SQL:不走索引,复杂逻辑,切割大事务.</li>
<li>避免业务逻辑错误,避免锁争用.<br>这个阶段,需要我们DBA深入业务,或者要和开发人员\业务人员配合实现</li>
</ol>
<h2 id="7-参数优化"><a href="#7-参数优化" class="headerlink" title="7.参数优化"></a>7.参数优化</h2><h3 id="7-1-max-connections-最大连接数"><a href="#7-1-max-connections-最大连接数" class="headerlink" title="7.1:max_connections 最大连接数"></a>7.1:max_connections 最大连接数</h3><p>（1）简介<br>Mysql的最大连接数，如果服务器的并发请求量比较大，可以调高这个值，当然这是要建立在机器能够支撑的情况下，因为如果连接数越来越多，mysql会为每个连接提供缓冲区，就会开销的越多的内存，所以需要适当的调整该值，不能随便去提高设值。<br>（2）判断依据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">&#x27;max_connections&#x27;</span>; //最大连接数</span><br><span class="line">    +-----------------+-------+</span><br><span class="line">    | Variable_name   | Value |</span><br><span class="line">    +-----------------+-------+</span><br><span class="line">    | max_connections | 151   |</span><br><span class="line">    +-----------------+-------+</span><br><span class="line">show status like <span class="string">&#x27;Max_used_connections&#x27;</span>; //最大使用过的连接数</span><br><span class="line">    +----------------------+-------+</span><br><span class="line">    | Variable_name        | Value |</span><br><span class="line">    +----------------------+-------+</span><br><span class="line">    | Max_used_connections | 152   |</span><br><span class="line">    +----------------------+-------+</span><br></pre></td></tr></table></figure>
<p>（3）修改方式举例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf </span><br><span class="line">max_connections=1024</span><br></pre></td></tr></table></figure>
<p>补充:</p>
<ul>
<li>1.开启数据库时,我们可以临时设置一个比较大的测试值</li>
<li>2.观察show status like ‘Max_used_connections’;变化</li>
<li>3.如果max_used_connections跟max_connections相同,<br>  那么就是max_connections设置过低或者超过服务器的负载上限了，CPU低于10%则设置过大. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">再次运行压力测试：</span><br><span class="line">[root@db03 ~]<span class="comment"># mysqlslap --defaults-file=/etc/my.cnf --socket /tmp/mysql.sock --concurrency=1000 --iterations=1 --create-schema=&#x27;oldboy&#x27; --query=&quot;select * from oldboy.t100w where k2=&#x27;GHvw&#x27;&quot; engine=innodb --number-of-queries=20000 -verbose</span></span><br><span class="line">    </span><br><span class="line">%Cpu0  : 99.3 us,  0.7 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu1  : 99.3 us,  0.7 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu2  : 99.3 us,  0.7 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu3  : 99.7 us,  0.3 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :  3880016 total,   510428 free,   743280 used,  2626308 buff/cache</span><br><span class="line">KiB Swap:  2097148 total,  2097148 free,        0 used.  2881592 avail Mem </span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                         </span><br><span class="line"> 6129 mysql     20   0 2898540 436412  11212 S 399.3 11.2   6:27.35 mysqld  </span><br><span class="line">//CPU压力过高，说明最大连接数还是得调低。</span><br><span class="line"></span><br><span class="line">db03 [(none)]&gt;show variables like <span class="string">&#x27;max_connections&#x27;</span>;</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| Variable_name   | Value |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| max_connections | 1024  |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">db03 [(none)]&gt;show status like <span class="string">&#x27;Max_used_connections&#x27;</span>;</span><br><span class="line">+----------------------+-------+</span><br><span class="line">| Variable_name        | Value |</span><br><span class="line">+----------------------+-------+</span><br><span class="line">| Max_used_connections | 1002  |</span><br><span class="line">+----------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-2-back-log-预备连接数"><a href="#7-2-back-log-预备连接数" class="headerlink" title="7.2:back_log 预备连接数"></a>7.2:back_log 预备连接数</h3><p>（1）简介<br>mysql能暂存的连接数量，当主要mysql线程在一个很短时间内得到非常多的连接请求时候它就会起作用，如果mysql的连接数据达到max_connections时候，新来的请求将会被存在堆栈中，等待某一连接释放资源，该推栈的数量及back_log,如果等待连接的数量超过back_log，将不被授予连接资源。<br>back_log值指出在mysql暂时停止回答新请求之前的短时间内有多少个请求可以被存在推栈中，只有如果期望在一个短时间内有很多连接的时候需要增加它<br>（2）判断依据<br><code>show full processlist</code><br>发现大量的待连接进程时，就需要加大back_log或者加大<code>max_connections</code>的值<br>（3）修改方式举例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf </span><br><span class="line">back_log=1024 //额外的1024个进程等待资源释放后立即工作。减少报错</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-3-wait-timeout和interactive-timeout-会话超时"><a href="#7-3-wait-timeout和interactive-timeout-会话超时" class="headerlink" title="7.3:wait_timeout和interactive_timeout  会话超时"></a>7.3:wait_timeout和interactive_timeout  会话超时</h3><p>（1）简介<br><code>wait_timeout：</code>指的是mysql在关闭一个非交互的连接之前所要等待的秒数<br><code>interactive_timeout：</code>指的是mysql在关闭一个交互的连接之前所需要等待的秒数，比如我们在终端上进行mysql管理，使用的即使交互的连接，这时候，如果没有操作的时间超过了interactive_time设置的时间就会自动的断开，默认的是28800，可调优为7200。<br>wait_timeout:如果设置太小，那么连接关闭的就很快，从而使一些持久的连接不起作用<br>（2）设置建议<br>如果设置太大，容易造成连接打开时间过长，在show processlist时候，能看到很多的连接 ，一般希望wait_timeout尽可能低<br>（3）修改方式举例<br><code>wait_timeout=60</code> //空闲60s自动断开√<br><code>interactive_timeout=1200</code> //1200s自动断开<br>长连接的应用，为了不去反复的回收和分配资源，降低额外的开销</p>
<p>注意：一般我们会将<code>wait_timeout</code>设定比较小，<code>interactive_timeout</code>要和应用开发人员沟通长链接的应用是否很多。如果他需要长链接，那么这个值可以不需要调整。<br>另外还可以使用类外的参数弥补。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db03 [(none)]&gt;show variables like <span class="string">&#x27;%timeout%&#x27;</span></span><br><span class="line">    -&gt; ;</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line">| Variable_name               | Value    |</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line">| connect_timeout             | 10       |</span><br><span class="line">| delayed_insert_timeout      | 300      |</span><br><span class="line">| have_statement_timeout      | YES      |</span><br><span class="line">| innodb_flush_log_at_timeout | 1        |</span><br><span class="line">| innodb_lock_wait_timeout    | 50       |</span><br><span class="line">| innodb_rollback_on_timeout  | OFF      |</span><br><span class="line">| interactive_timeout         | 28800    | //会话超时每8小时</span><br><span class="line">| lock_wait_timeout           | 31536000 |</span><br><span class="line">| net_read_timeout            | 30       |</span><br><span class="line">| net_write_timeout           | 60       |</span><br><span class="line">| rpl_stop_slave_timeout      | 31536000 |</span><br><span class="line">| slave_net_timeout           | 60       |</span><br><span class="line">| wait_timeout                | 28800    | //默认8小时</span><br><span class="line">+-----------------------------+----------+</span><br><span class="line">13 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-4-key-buffer-size-临时表相关"><a href="#7-4-key-buffer-size-临时表相关" class="headerlink" title="7.4:key_buffer_size 临时表相关"></a>7.4:key_buffer_size 临时表相关</h3><p>（1）简介<br>key_buffer_size指定索引缓冲区的大小，它决定索引处理的速度，尤其是索引读的速度<br>《1》此参数与myisam表的索引有关(几乎不用)<br>《2》临时表的创建有关（多表链接、子查询中、union）<br>     在有以上查询语句出现的时候，需要创建临时表，用完之后会被丢弃<br>     临时表有两种创建方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">内存中-------&gt;key_buffer_size</span><br><span class="line">磁盘上-------&gt;ibdata1(5.6)</span><br><span class="line">              ibtmp1 (5.7）</span><br></pre></td></tr></table></figure>
<p>（2）设置依据<br>通过key_read_requests和key_reads可以直到key_baffer_size设置是否合理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&quot;key_buffer_size%&quot;</span>;</span><br><span class="line">+-----------------+---------+</span><br><span class="line">| Variable_name   | Value   |</span><br><span class="line">+-----------------+---------+</span><br><span class="line">| key_buffer_size | 8388608 |//默认为8M</span><br><span class="line">+-----------------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show status like <span class="string">&quot;key_read%&quot;</span>;</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name     | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Key_read_requests | 10    |</span><br><span class="line">| Key_reads         | 2     |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>一共有10个索引读取请求，有2个请求在内存中没有找到直接从硬盘中读取索引<br>控制在 5%以内 。<br>注：key_buffer_size只对myisam表起作用，即使不使用myisam表，但是内部的临时磁盘表是myisam表，也要使用该值。<br>可以使用检查状态值created_tmp_disk_tables得知：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like <span class="string">&quot;created_tmp%&quot;</span>;   //创建临时表的状态信息</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">| Variable_name           | Value |</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">| Created_tmp_disk_tables | 0     | //在磁盘上生成的文件个数</span><br><span class="line">| Created_tmp_files       | 6     | //临时表的个数</span><br><span class="line">| Created_tmp_tables      | 1     | //在内存中生成的个数</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure>
<p>通常地，我们习惯以<br>Created_tmp_tables/(Created_tmp_disk_tables + Created_tmp_tables)   越高越好<br>内存中生成的/(磁盘中生成+内存中生成的)<br>Created_tmp_disk_tables/(Created_tmp_disk_tables + Created_tmp_tables) </p>
<p>或者已各自的一个时段内的差额计算，来判断基于内存的临时表利用率。所以，我们会比较关注 Created_tmp_disk_tables 是否过多，从而认定当前服务器运行状况的优劣。<br>Created_tmp_disk_tables/(Created_tmp_disk_tables + Created_tmp_tables)<br>控制在5%-10%以内</p>
<p>看以下例子：<br>在调用mysqldump备份数据时，大概执行步骤如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">180322 17:39:33       7 Connect     root@localhost on</span><br><span class="line">7 Query       /*!40100 SET @@SQL_MODE=<span class="string">&#x27;&#x27;</span> */</span><br><span class="line">7 Init DB     guo</span><br><span class="line">7 Query       SHOW TABLES LIKE <span class="string">&#x27;guo&#x27;</span></span><br><span class="line">7 Query       LOCK TABLES `guo` READ /*!32311 LOCAL */</span><br><span class="line">7 Query       SET OPTION SQL_QUOTE_SHOW_CREATE=1</span><br><span class="line">7 Query       show create table `guo`</span><br><span class="line">7 Query       show fields from `guo`</span><br><span class="line">7 Query       show table status like <span class="string">&#x27;guo&#x27;</span></span><br><span class="line">7 Query       SELECT /*!40001 SQL_NO_CACHE */ * FROM `guo`</span><br><span class="line">7 Query       UNLOCK TABLES</span><br><span class="line">7 Quit</span><br></pre></td></tr></table></figure>
<p>其中，有一步是：show fields from <code>guo</code>。从slow query记录的执行计划中，可以知道它也产生了 Tmp_table_on_disk。</p>
<p>所以说，以上公式并不能真正反映到mysql里临时表的利用率，有些情况下产生的 Tmp_table_on_disk 我们完全不用担心，因此没必要过分关注 Created_tmp_disk_tables，但如果它的值大的离谱的话，那就好好查一下，你的服务器到底都在执行什么查询了。 zabbix在监控时，应避开备份时段。否则在备份时临时表在硬盘中生成的比例会大大增加。<br>（3）配置方法<br>key_buffer_size=64M</p>
<hr>
<h3 id="7-5-query-cache-size-查询缓存"><a href="#7-5-query-cache-size-查询缓存" class="headerlink" title="7.5:query_cache_size 查询缓存"></a>7.5:query_cache_size 查询缓存</h3><p>（1）简介：<br>查询缓存简称QC，使用查询缓冲，mysql将查询结果存放在缓冲区中，今后对于同样的select语句（区分大小写）,将直接从缓冲区中读取结果。</p>
<p>SQL层：<br>select * from t1 where name=:NAME;<br>select * from t1 where name=:NAME;</p>
<p>1、查询完结果之后，会对SQL语句进行hash运算，得出hash值,我们把他称之为SQL_ID<br>2、会将存储引擎返回的结果+SQL_ID存储到缓存中。</p>
<p>存储方式：<br>例子：select * from t1  where id=10;      100次</p>
<p>1、将select * from t1  where id=10; 进行hash运算计算出一串hash值，我们把它称之为“SQL_ID”<br>2、将存储引擎返回上来的表的内容+SQLID存储到查询缓存中</p>
<p>使用方式：<br>1、一条SQL执行时，进行hash运算，得出SQLID，去找query cache<br>2、如果cache中有，则直接返回数据行，如果没有，就走原有的SQL执行流程</p>
<p>一个sql查询如果以select开头，那么mysql服务器将尝试对其使用查询缓存。<br>注：两个sql语句，只要想差哪怕是一个字符（列如大小写不一样；多一个空格等）,那么这两个sql将使用不同的一个cache。</p>
<p>（2）判断依据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like <span class="string">&quot;%Qcache%&quot;</span>;</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">| Variable_name           | Value   |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">| Qcache_free_blocks      | 1       |</span><br><span class="line">| Qcache_free_memory      | 1031360 |</span><br><span class="line">| Qcache_hits             | 0       |</span><br><span class="line">| Qcache_inserts          | 0       |</span><br><span class="line">| Qcache_lowmem_prunes    | 0       |</span><br><span class="line">| Qcache_not_cached       | 2002    |</span><br><span class="line">| Qcache_queries_in_cache | 0       |</span><br><span class="line">| Qcache_total_blocks     | 1       |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>———————状态说明——————–<br><code>Qcache_free_blocks：</code>缓存中相邻内存块的个数。<br>如果该值显示较大，则说明Query Cache 中的内存碎片较多了，FLUSH QUERY CACHE会对缓存中的碎片进行整理，从而得到一个空闲块。<br>注：当一个表被更新之后，和它相关的cache<br>blocks将被free。但是这个block依然可能存在队列中，除非是在队列的尾部。可以用FLUSH QUERY CACHE语句来清空free blocks</p>
<p><code>Qcache_free_memory：</code>Query Cache 中目前剩余的内存大小。通过这个参数我们可以较为准确的观察出当前系统中的Query Cache 内存大小是否足够，是需要增加还是过多了。</p>
<p><code>Qcache_hits：</code>表示有多少次命中缓存。我们主要可以通过该值来验证我们的查询缓存的效果。数字越大，缓存效果越理想。</p>
<p><code>Qcache_inserts：</code>表示多少次未命中然后插入，意思是新来的SQL请求在缓存中未找到，不得不执行查询处理，执行查询处理后把结果insert到查询缓存中。这样的情况的次数越多，表示查询缓存应用到的比较少，效果也就不理想。当然系统刚启动后，查询缓存是空的，这很正常。</p>
<p><code>Qcache_lowmem_prunes：</code><br>多少条Query因为内存不足而被清除出QueryCache。通过“Qcache_lowmem_prunes”和“Qcache_free_memory”相互结合，能够更清楚的了解到我们系统中Query Cache 的内存大小是否真的足够，是否非常频繁的出现因为内存不足而有Query 被换出。这个数字最好长时间来看；如果这个数字在不断增长，就表示可能碎片非常严重，或者内存很少。（上面的free_blocks和free_memory可以告诉您属于哪种情况）</p>
<p><code>Qcache_not_cached：</code>不适合进行缓存的查询的数量，通常是由于这些查询不是 SELECT 语句或者用了now()之类的函数。</p>
<p><code>Qcache_queries_in_cache：</code>当前<code>Query Cache </code>中<code>cache</code> 的<code>Query </code>数量；<br>Qcache_total_blocks：当前Query Cache 中的block 数量；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Qcache_hits / (Qcache_inserts+Qcache_not_cached+Qcache_hits) </span><br><span class="line">    90/         10000             0             90</span><br></pre></td></tr></table></figure>
<p>如果出现hits比例过低，其实就可以关闭查询缓存了。使用redis专门缓存数据库</p>
<p><code>Qcache_free_blocks</code>    来判断碎片<br><code>Qcache_free_memory</code>   +   <code>Qcache_lowmem_prunes </code> 来判断内存够不够<br><code>Qcache_hits</code> 多少次命中  <code>Qcache_hits / (Qcache_inserts+Qcache_not_cached+Qcache_hits) </code> </p>
<p>（3）配置示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;%query_cache%&#x27;</span> ;</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">| Variable_name                | Value   |</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">| have_query_cache             | YES     |</span><br><span class="line">| query_cache_limit            | 1048576 |</span><br><span class="line">| query_cache_min_res_unit     | 4096    |</span><br><span class="line">| query_cache_size             | 1048576 |</span><br><span class="line">| query_cache_type             | OFF     |</span><br><span class="line">| query_cache_wlock_invalidate | OFF     |</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure>
<p>——————-配置说明——————————-<br>以上信息可以看出<code>query_cache_type</code>为off表示不缓存任何查询</p>
<p>各字段的解释：<br><code>query_cache_limit：</code>超过此大小的查询将不缓存<br><code>query_cache_min_res_unit：</code>缓存块的最小大小，<code>query_cache_min_res_unit</code>的配置是一柄”双刃剑”，默认是4KB，设置值大对大数据查询有好处，但如果你的查询都是小数据查询，就容易造成内存碎片和浪费。<br><code>query_cache_size：</code>查询缓存大小 (注：QC存储的最小单位是1024byte，所以如果你设定了一个不是1024的倍数的值，这个值会被四舍五入到最接近当前值的等于1024的倍数的值。)</p>
<p><code>query_cache_type：</code>缓存类型，决定缓存什么样的查询，注意这个值不能随便设置，必须设置为数字，可选项目以及说明如下：<br>如果设置为0，那么可以说，你的缓存根本就没有用，相当于禁用了。<br>如果设置为1，将会缓存所有的结果，除非你的select语句使用SQL_NO_CACHE禁用了查询缓存。<br>如果设置为2，则只缓存在select语句中通过SQL_CACHE指定需要缓存的查询。</p>
<p>修改/etc/my.cnf,配置完后的部分文件如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query_cache_size=128M</span><br><span class="line">query_cache_type=1</span><br><span class="line">max_connect_errors ***</span><br></pre></td></tr></table></figure>
<p><code>max_connect_errors</code>是一个mysql中与安全有关的计数器值，它负责阻止过多尝试失败的客户端以防止暴力破解密码等情况，当超过指定次数，mysql服务器将禁止host的连接请求，直到mysql服务器重启或通过flush hosts命令清空此host的相关信息 max_connect_errors的值与性能并无太大关系。<br>修改<code>/etc/my.cnf</code>文件，在[mysqld]下面添加如下内容<br><code>max_connect_errors=2000</code></p>
<hr>
<h3 id="7-6-sort-buffer-size-会话排序缓冲区"><a href="#7-6-sort-buffer-size-会话排序缓冲区" class="headerlink" title="7.6:sort_buffer_size 会话排序缓冲区"></a>7.6:sort_buffer_size 会话排序缓冲区</h3><p>（1）简介：<br>每个需要进行排序的线程分配该大小的一个缓冲区。增加这值加速<br>ORDER BY<br>GROUP BY<br>distinct<br>union<br>（2）配置依据<br>Sort_Buffer_Size并不是越大越好，由于是connection级的参数，过大的设置+高并发可能会耗尽系统内存资源。<br>列如：500个连接将会消耗 500*sort_buffer_size（2M）=1G内</p>
<p>计算公式：<code>16*1024/1024/8</code></p>
<p>（3）配置方法<br> 修改/etc/my.cnf文件，在[mysqld]下面添加如下：<br><code>sort_buffer_size=1M</code></p>
<hr>
<h3 id="7-7-max-allowed-packet-接收最大数据包大小"><a href="#7-7-max-allowed-packet-接收最大数据包大小" class="headerlink" title="7.7:max_allowed_packet 接收最大数据包大小"></a>7.7:max_allowed_packet 接收最大数据包大小</h3><p>（1）简介：<br>mysql根据配置文件会限制，server接受的数据包大小。<br>（2）配置依据：<br>有时候大的插入和更新会受max_allowed_packet参数限制，导致写入或者更新失败，更大值是1GB，必须设置1024的倍数。在mysqldump备份时会用到<br>（3）配置方法：<br><code>max_allowed_packet=256M</code></p>
<hr>
<h3 id="7-8-join-buffer-size-关联表缓存大小"><a href="#7-8-join-buffer-size-关联表缓存大小" class="headerlink" title="7.8:join_buffer_size 关联表缓存大小"></a>7.8:join_buffer_size 关联表缓存大小</h3><p>select a.name,b.name from   a  join b on a.id=b.id where xxxx</p>
<ul>
<li>数据量级小的表放在左边，通过<code>left join</code>强制指定驱动表</li>
</ul>
<p>作用：用于表间关联缓存的大小，和sort_buffer_size一样，该参数对应的分配内存也是每个连接独享，计算公式类似于7.6。<br>尽量在SQL与方面进行优化，效果较为明显。<br>优化的方法：在on条件列加索引，至少应当是有MUL索引</p>
<hr>
<h3 id="7-9-thread-cache-size-预分配保留线程"><a href="#7-9-thread-cache-size-预分配保留线程" class="headerlink" title="7.9:thread_cache_size 预分配保留线程"></a>7.9:thread_cache_size 预分配保留线程</h3><p>（1）简介<br>服务器线程缓存，这个值表示可以重新利用保存在缓存中线程的数量,当断开连接时,那么客户端的线程将被放到缓存中以响应下一个客户而不是销毁(前提是缓存数未达上限),如果线程重新被请求，那么请求将从缓存中读取,如果缓存中是空的或者是新的请求，那么这个线程将被重新创建,如果有很多新的线程，增加这个值可以改善系统性能.<br>（2）配置依据</p>
<ul>
<li>通过比较 Connections 和 Threads_created 状态的变量，可以看到这个变量的作用。</li>
<li>设置规则如下：1GB 内存配置为8，2GB配置为16，3GB配置为32，4GB或更高内存，可配置更大。</li>
<li>服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限)</li>
</ul>
<p>试图连接到MySQL(不管是否连接成功)的连接数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">db03 [(none)]&gt;show variables like <span class="string">&quot;thread_cache_size&quot;</span>;</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name     | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| thread_cache_size | 18    | //可重用线程数量</span><br><span class="line">+-------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line">db03 [(none)]&gt;show status like <span class="string">&#x27;threads_%&#x27;</span>;</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name     | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Threads_cached    | 17    | //空闲线程</span><br><span class="line">| Threads_connected | 1     | //已建立连接的数量</span><br><span class="line">| Threads_created   | 1002  | //新创建的线程,正常情况下不会持续上升</span><br><span class="line">| Threads_running   | 1     |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><code>Threads_cached </code>:代表当前此时此刻线程缓存中有多少空闲线程。<br><code>Threads_connected</code>:代表当前已建立连接的数量，因为一个连接就需要一个线程，所以也可以看成当前被使用的线程数。<br><code>Threads_created</code>:代表从最近一次服务启动，已创建线程的数量，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，这也是比较耗cpu SYS资源，可以适当增加配置文件中thread_cache_size值。<br><code>Threads_running</code> :代表当前激活的（非睡眠状态）线程数。并不是代表正在使用的线程数，有时候连接已建立，但是连接处于sleep状态。<br>（3）配置方法：<br><code>thread_cache_size=32</code></p>
<p>整理：<br>Threads_created  ：</p>
<ul>
<li>一般在架构设计阶段，会设置一个测试值，做压力测试。</li>
<li>结合zabbix监控，看一段时间内此状态的变化。</li>
<li>如果在一段时间内，Threads_created趋于平稳，说明对应参数设定是OK。</li>
<li>如果一直陡峭的增长，或者出现大量峰值，那么继续增加此值的大小，在系统资源够用的情况下（内存）</li>
</ul>
<hr>
<h3 id="7-10-innodb-buffer-pool-size-数据页索引缓冲大小"><a href="#7-10-innodb-buffer-pool-size-数据页索引缓冲大小" class="headerlink" title="7.10:innodb_buffer_pool_size 数据页索引缓冲大小"></a>7.10:innodb_buffer_pool_size 数据页索引缓冲大小</h3><p>（1）简介<br>对于InnoDB表来说，<code>innodb_buffer_pool_size</code>的作用就相当于<code>key_buffer_size</code>对于MyISAM表的作用一样。<br>（2）配置依据：<br>InnoDB使用该参数指定大小的内存来缓冲数据和索引。<br>对于单独的MySQL数据库服务器，最大可以把该值设置成物理内存的80%,一般我们建议不要超过物理内存的70%。<br>（3）配置方法<br><code>innodb_buffer_pool_size=2048M</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">db03 [(none)]&gt;select @@innodb_buffer_pool_size;</span><br><span class="line">+---------------------------+</span><br><span class="line">| @@innodb_buffer_pool_size |</span><br><span class="line">+---------------------------+</span><br><span class="line">|                 134217728 |//默认大小/字节</span><br><span class="line">+---------------------------+</span><br><span class="line">db03 [(none)]&gt;show engine innodb status\G</span><br><span class="line">----------------------</span><br><span class="line">BUFFER POOL AND MEMORY</span><br><span class="line">----------------------</span><br><span class="line">Total large memory allocated 137428992 <span class="comment"># 分配给InnoDB缓存池的内存(字节)换算成MB 为128M</span></span><br><span class="line">Dictionary memory allocated 120758 <span class="comment"># 分配给InnoDB数据字典的内存(字节)</span></span><br><span class="line">Buffer pool size   8191 //最多可缓存的数据页数量 8191x16kb=131056kb=127.984375兆字节(mb)</span><br><span class="line">Free buffers       4891 // 缓存池空闲链表的页数目 &lt;==观察剩余，剩余10%考虑增加buffer_pool大小</span><br><span class="line">Database pages     3300 // 缓存池LRU链表的页数目</span><br><span class="line">Old database pages 1238 // 修改过的页数目</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-11-innodb-flush-log-at-trx-commit-控制redo-buffer-刷写策略"><a href="#7-11-innodb-flush-log-at-trx-commit-控制redo-buffer-刷写策略" class="headerlink" title="7.11:innodb_flush_log_at_trx_commit 控制redo buffer 刷写策略"></a>7.11:innodb_flush_log_at_trx_commit 控制redo buffer 刷写策略</h3><p>（1）简介<br>主要控制了innodb将log buffer中的数据写入日志文件并flush磁盘的时间点，取值分别为0、1、2三个。<br>0，表示当事务提交时，不做日志写入操作，而是每秒钟将log buffer中的数据写入日志文件并flush磁盘一次；<br>1，每次事务的提交都会引起redo日志文件写入、flush磁盘的操作，确保了事务的ACID；<br>2，每次事务提交引起写入日志文件的动作,但每秒钟完成一次flush磁盘操作。</p>
<p>（2）配置依据<br>实际测试发现，该值对插入数据的速度影响非常大，设置为2时插入10000条记录只需要2秒，设置为0时只需要1秒，而设置为1时则需要229秒。因此，MySQL手册也建议尽量将插入操作合并成一个事务，这样可以大幅提高速度。<br>根据MySQL官方文档，在允许丢失最近部分事务的危险的前提下，可以把该值设为0或2。</p>
<p>（3）配置方法<br><code>innodb_flush_log_at_trx_commit=1</code>双1标准中的一个1<br>参见：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://pincheng.org/forward/3053135c.html#8-0-InnoDB%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0">https://pincheng.org/forward/3053135c.html#8-0-InnoDB%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0</a></p>
<hr>
<h3 id="7-12-innodb-thread-concurrency-多核并发处理控制"><a href="#7-12-innodb-thread-concurrency-多核并发处理控制" class="headerlink" title="7.12:innodb_thread_concurrency 多核并发处理控制"></a>7.12:innodb_thread_concurrency 多核并发处理控制</h3><p>（1）简介<br>此参数用来设置innodb线程的并发数量，默认值为0表示不限制。</p>
<p>（2）配置依据<br>在官方doc上，对于<code>innodb_thread_concurrency</code>的使用，也给出了一些建议，如下：<br>如果一个工作负载中，并发用户线程的数量小于64，建议设置<code>innodb_thread_concurrency=0</code>；<br>如果工作负载一直较为严重甚至偶尔达到顶峰，建议先设置<code>innodb_thread_concurrency=128</code>，<br>并通过不断的降低这个参数，96, 80, 64等等，直到发现能够提供最佳性能的线程数，<br>例如，假设系统通常有40到50个用户，但定期的数量增加至60，70，甚至200。你会发现，<br>性能在80个并发用户设置时表现稳定，如果高于这个数，性能反而下降。在这种情况下，<br>建议设置innodb_thread_concurrency参数为80，以避免影响性能。<br>如果你不希望InnoDB使用的虚拟CPU数量比用户线程使用的虚拟CPU更多（比如20个虚拟CPU），<br>建议通过设置innodb_thread_concurrency 参数为这个值（也可能更低，这取决于性能体现），<br>如果你的目标是将MySQL与其他应用隔离，你可以l考虑绑定mysqld进程到专有的虚拟CPU。<br>但是需 要注意的是，这种绑定，在myslqd进程一直不是很忙的情况下，可能会导致非最优的硬件使用率。在这种情况下，<br>你可能会设置mysqld进程绑定的虚拟 CPU，允许其他应用程序使用虚拟CPU的一部分或全部。<br>在某些情况下，最佳的innodb_thread_concurrency参数设置可以比虚拟CPU的数量小。<br>定期检测和分析系统，负载量、用户数或者工作环境的改变可能都需要对innodb_thread_concurrency参数的设置进行调整。</p>
<p>128   —–&gt; top  cpu<br>设置标准：</p>
<ul>
<li>1、当前系统cpu使用情况，均不均匀<br>top</li>
<li>2、当前的连接数，有没有达到顶峰<br><code>show statusg like &#39;threads_%&#39;;</code><br><code>show processlist;</code><br>（3）配置方法：<br><code>innodb_thread_concurrency=8</code><br>方法:</li>
</ul>
<ol>
<li>看top ,观察每个cpu的各自的负载情况</li>
<li>发现不平均,先设置参数为cpu个数,然后不断增加(一倍)这个数值</li>
<li>一直观察top状态,直到达到比较均匀时,说明已经到位了</li>
</ol>
<hr>
<h3 id="7-13-innodb-log-buffer-size-redo缓冲区大小控制"><a href="#7-13-innodb-log-buffer-size-redo缓冲区大小控制" class="headerlink" title="7.13:innodb_log_buffer_size  redo缓冲区大小控制"></a>7.13:innodb_log_buffer_size  redo缓冲区大小控制</h3><p>此参数确定些日志文件所用的内存大小，以M为单位。缓冲区更大能提高性能，对于较大的事务，可以增大缓存大小。<br><code>innodb_log_buffer_size=128M</code>到256M之间<br>设定依据：<br>1、大事务： 存储过程调用 CALL<br>2、多事务</p>
<hr>
<h3 id="7-14-innodb-log-file-size-100M-redo日志个数控制"><a href="#7-14-innodb-log-file-size-100M-redo日志个数控制" class="headerlink" title="7.14:innodb_log_file_size = 100M redo日志个数控制"></a>7.14:innodb_log_file_size = 100M redo日志个数控制</h3><p>设置 ib_logfile0  ib_logfile1<br>此参数确定数据日志文件的大小，以M为单位，更大的设置可以提高性能.<br>innodb_log_file_size = 100M<br><code>innodb_log_files_in_group = 3</code>到5组<br>为提高性能，MySQL可以以循环方式将日志文件写到多个文件。推荐设置为3</p>
<hr>
<h3 id="7-15-read-buffer-size-1M-顺序查询缓冲区"><a href="#7-15-read-buffer-size-1M-顺序查询缓冲区" class="headerlink" title="7.15:read_buffer_size = 1M 顺序查询缓冲区"></a>7.15:read_buffer_size = 1M 顺序查询缓冲区</h3><p>MySql读入缓冲区大小（会话级别的参数）。对表进行顺序扫描（如走索引）的请求将分配一个读入缓冲区，MySql会为它分配一段内存缓冲区。如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能。和 sort_buffer_size一样，该参数对应的分配内存也是每个连接独享</p>
<hr>
<h3 id="7-16-read-rnd-buffer-size-1M-随机查询缓冲区"><a href="#7-16-read-rnd-buffer-size-1M-随机查询缓冲区" class="headerlink" title="7.16:read_rnd_buffer_size = 1M 随机查询缓冲区"></a>7.16:read_rnd_buffer_size = 1M 随机查询缓冲区</h3><p>MySql的随机读（查询操作）缓冲区大小。当按任意顺序读取行时（不走索引）(例如，按照排序顺序)，将分配一个随机读缓存区。进行排序查询时，MySql会首先扫描一遍该缓冲，以避免磁盘搜索，提高查询速度，如果需要排序大量数据，可适当调高该值。但MySql会为每个客户连接发放该缓冲空间，所以应尽量适当设置该值，以避免内存开销过大。<br>注：顺序读是指根据索引的叶节点数据就能顺序地读取所需要的行数据。随机读是指一般需要根据辅助索引叶节点中的主键寻找实际行数据，而辅助索引和主键所在的数据段不同，因此访问方式是随机的。</p>
<hr>
<h3 id="7-17-bulk-insert-buffer-size-8M-插入缓冲区大小"><a href="#7-17-bulk-insert-buffer-size-8M-插入缓冲区大小" class="headerlink" title="7.17:bulk_insert_buffer_size = 8M 插入缓冲区大小"></a>7.17:bulk_insert_buffer_size = 8M 插入缓冲区大小</h3><p>批量插入数据缓存大小，可以有效提高插入效率，默认为8M</p>
<ul>
<li>tokuDB    percona</li>
<li>myrocks   </li>
<li>RocksDB</li>
<li>TiDB</li>
<li>MongoDB</li>
</ul>
<hr>
<h3 id="7-18-binary-log-binlog相关参数"><a href="#7-18-binary-log-binlog相关参数" class="headerlink" title="7.18:binary log binlog相关参数"></a>7.18:binary log binlog相关参数</h3><p><code>log-bin=/data/mysql-bin</code><br><code>binlog_cache_size = 2M</code> //为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存, 提高记录bin-log的效率。没有什么大事务，dml也不是很频繁的情况下可以设置小一点，如果事务大而且多，dml操作也频繁，则可以适当的调大一点。前者建议是–1M，后者建议是：即 2–4M<br><code>max_binlog_cache_size = 8M</code> //表示的是binlog 能够使用的最大cache 内存大小<br><code>max_binlog_size= 512M </code><br>//指定binlog日志文件的大小，如果当前的日志大小达到max_binlog_size，还会自动创建新的二进制日志。你不能将该变量设置为大于1GB或小于4096字节。默认值是1GB。在导入大容量的sql文件时，建议关闭sql_log_bin，否则硬盘扛不住，而且建议定期做删除。</p>
<p><code>expire_logs_days = 7</code> //定义了mysql清除过期日志的时间。<br>二进制日志自动删除的天数。默认值为0,表示“没有自动删除”。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log-bin=/data/mysql-bin</span><br><span class="line">binlog_format=row </span><br><span class="line">sync_binlog=1</span><br></pre></td></tr></table></figure>
<p>双1标准(基于安全的控制)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sync_binlog=1   什么时候刷新binlog到磁盘，每次事务commit</span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line"><span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line">show status like <span class="string">&#x27;com_%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-19-安全参数"><a href="#7-19-安全参数" class="headerlink" title="7.19:安全参数"></a>7.19:安全参数</h3><p><code>Innodb_flush_method=(O_DIRECT, fsync) </code><br>1、fsync：<br>（1）在数据页需要持久化时，首先将数据写入OS buffer中，然后由os决定什么时候写入磁盘<br>（2）在redo buffuer需要持久化时，首先将数据写入OS buffer中，然后由os决定什么时候写入磁盘<br>但，如果<code>innodb_flush_log_at_trx_commit=1</code>的话，日志还是直接每次commit直接写入磁盘<br>2、 Innodb_flush_method=O_DIRECT<br>（1）在数据页需要持久化时，直接写入磁盘<br>（2）在redo buffuer需要持久化时，首先将数据写入OS buffer中，然后由os决定什么时候写入磁盘<br>但，如果<code>innodb_flush_log_at_trx_commit=1</code>的话，日志还是直接每次commit直接写入磁盘</p>
<p>最安全模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br></pre></td></tr></table></figure>
<p>最高性能模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit=0</span><br><span class="line">innodb_flush_method=fsync</span><br></pre></td></tr></table></figure>
<p>一般情况下，我们更偏向于安全。<br>“双一标准”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit=1        ***************</span><br><span class="line">sync_binlog=1                           ***************</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-参数优化结果"><a href="#8-参数优化结果" class="headerlink" title="8. 参数优化结果"></a>8. 参数优化结果</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">basedir=/data/mysql</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log-error=/var/<span class="built_in">log</span>/mysql.log</span><br><span class="line">log_bin=/data/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">skip-name-resolve</span><br><span class="line">server-id=52</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=<span class="literal">true</span></span><br><span class="line">log-slave-updates=1</span><br><span class="line">relay_log_purge=0</span><br><span class="line"></span><br><span class="line">max_connections=1024</span><br><span class="line">back_log=128</span><br><span class="line">wait_timeout=60</span><br><span class="line">interactive_timeout=7200</span><br><span class="line">key_buffer_size=16M</span><br><span class="line">query_cache_size=64M</span><br><span class="line">query_cache_type=1</span><br><span class="line">query_cache_limit=50M</span><br><span class="line">max_connect_errors=20</span><br><span class="line">sort_buffer_size=2M</span><br><span class="line">max_allowed_packet=32M</span><br><span class="line">join_buffer_size=2M</span><br><span class="line">thread_cache_size=200</span><br><span class="line">innodb_buffer_pool_size=1024M</span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line">innodb_log_buffer_size=32M</span><br><span class="line">innodb_log_file_size=128M</span><br><span class="line">innodb_log_files_in_group=3</span><br><span class="line">binlog_cache_size=2M</span><br><span class="line">max_binlog_cache_size=8M</span><br><span class="line">max_binlog_size=512M</span><br><span class="line">expire_logs_days=7</span><br><span class="line">read_buffer_size=2M</span><br><span class="line">read_rnd_buffer_size=2M</span><br><span class="line">bulk_insert_buffer_size=8M</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br></pre></td></tr></table></figure>

<h3 id="8-1测试："><a href="#8-1测试：" class="headerlink" title="8.1测试："></a>8.1测试：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">优化前：</span><br><span class="line">[root@db03 ~]<span class="comment"># mysqlslap --defaults-file=/etc/my.cnf --socket /tmp/mysql.sock --concurrency=100 --iterations=1 --create-schema=&#x27;oldboy&#x27; --query=&quot;select * from oldboy.t100w where k2=&#x27;GHvw&#x27;&quot; engine=innodb --number-of-queries=2000 -verbose</span></span><br><span class="line">Benchmark</span><br><span class="line">        Running <span class="keyword">for</span> engine rbose</span><br><span class="line">        Average number of seconds to run all queries: 184.616 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 184.616 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 184.616 seconds</span><br><span class="line">        Number of clients running queries: 100</span><br><span class="line">        Average number of queries per client: 20</span><br><span class="line">//184秒</span><br><span class="line"></span><br><span class="line">优化后：</span><br><span class="line">[root@db03 ~]<span class="comment"># mysqlslap --defaults-file=/etc/my.cnf --socket /tmp/mysql.sock --concurrency=100 --iterations=1 --create-schema=&#x27;oldboy&#x27; --query=&quot;select * from oldboy.t100w where k2=&#x27;GHvw&#x27;&quot; engine=innodb --number-of-queries=2000 -verbose</span></span><br><span class="line">Benchmark</span><br><span class="line">        Running <span class="keyword">for</span> engine rbose</span><br><span class="line">        Average number of seconds to run all queries: 9.411 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 9.411 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 9.411 seconds</span><br><span class="line">        Number of clients running queries: 100</span><br><span class="line">        Average number of queries per client: 20</span><br><span class="line">//9秒</span><br><span class="line"></span><br><span class="line">建立索引后：</span><br><span class="line">db03 [(none)]&gt;alter table oldboy.t100w add index idx_k2(k2);</span><br><span class="line">Query OK, 0 rows affected (1.66 sec)</span><br><span class="line"></span><br><span class="line">再次测试：</span><br><span class="line">[root@db03 ~]<span class="comment"># mysqlslap --defaults-file=/etc/my.cnf --socket /tmp/mysql.sock --concurrency=100 --iterations=1 --create-schema=&#x27;oldboy&#x27; --query=&quot;select * from oldboy.t100w where k2=&#x27;GHvw&#x27;&quot; engine=innodb --number-of-queries=2000 -verbose</span></span><br><span class="line">Benchmark</span><br><span class="line">        Running <span class="keyword">for</span> engine rbose</span><br><span class="line">        Average number of seconds to run all queries: 0.083 seconds</span><br><span class="line">        Minimum number of seconds to run all queries: 0.083 seconds</span><br><span class="line">        Maximum number of seconds to run all queries: 0.083 seconds</span><br><span class="line">        Number of clients running queries: 100</span><br><span class="line">        Average number of queries per client: 20</span><br><span class="line">//0.083秒</span><br></pre></td></tr></table></figure>

<h2 id="9-锁的监控及处理"><a href="#9-锁的监控及处理" class="headerlink" title="9.锁的监控及处理"></a>9.锁的监控及处理</h2><h3 id="9-1-锁等待模拟"><a href="#9-1-锁等待模拟" class="headerlink" title="9.1 锁等待模拟"></a>9.1 锁等待模拟</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">innodb_lock_wait_timeout=28800</span><br><span class="line"></span><br><span class="line">tx1:</span><br><span class="line">USE oldboy</span><br><span class="line">UPDATE t_100w SET k1=<span class="string">&#x27;av&#x27;</span> WHERE id=10;</span><br><span class="line"><span class="comment">## tx2:</span></span><br><span class="line">USE oldboy </span><br><span class="line">UPDATE  t_100w SET k1=<span class="string">&#x27;az&#x27;</span> WHERE id=10;</span><br></pre></td></tr></table></figure>

<p><img src="/images/img-99.png" alt="锁等待"></p>
<h3 id="1-看有没有锁等待"><a href="#1-看有没有锁等待" class="headerlink" title="1. 看有没有锁等待"></a>1. 看有没有锁等待</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SHOW  STATUS LIKE <span class="string">&#x27;innodb_row_lock%&#x27;</span>;</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">| Variable_name                 | Value |</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">| Innodb_row_lock_current_waits | 1     | //当前多少个锁等待</span><br><span class="line">| Innodb_row_lock_time          | 0     |</span><br><span class="line">| Innodb_row_lock_time_avg      | 0     |</span><br><span class="line">| Innodb_row_lock_time_max      | 0     |</span><br><span class="line">| Innodb_row_lock_waits         | 1     | //历史</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-查看哪个事务在等待-被阻塞了"><a href="#2-查看哪个事务在等待-被阻塞了" class="headerlink" title="2. 查看哪个事务在等待(被阻塞了)"></a>2. 查看哪个事务在等待(被阻塞了)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">USE information_schema</span><br><span class="line">SELECT * FROM information_schema.INNODB_TRX WHERE trx_state=<span class="string">&#x27;LOCK WAIT&#x27;</span>;</span><br><span class="line">trx_query: update  t100w <span class="built_in">set</span> k1=<span class="string">&#x27;az&#x27;</span> WHERE id=10: 被阻塞的语句是谁 </span><br><span class="line">                          trx_mysql_thread_id: 5: 被阻塞的会话ID</span><br></pre></td></tr></table></figure>
<h3 id="3-查看锁源-谁锁的我"><a href="#3-查看锁源-谁锁的我" class="headerlink" title="3.查看锁源,谁锁的我!"></a>3.查看锁源,谁锁的我!</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM sys.innodb_lock_waits;     <span class="comment">## ====&gt;被锁的和锁定它的之间关系</span></span><br><span class="line"><span class="comment">##                 waiting_pid: 5 等待的会话线程号</span></span><br><span class="line"><span class="comment">##               waiting_query: update  t100w set k1=&#x27;az&#x27; WHERE id=10 等待的语句 </span></span><br><span class="line"><span class="comment">##                blocking_pid: 4 锁源的线程号</span></span><br><span class="line"><span class="comment">##     sql_kill_blocking_query: KILL QUERY 4 处理建议</span></span><br><span class="line"><span class="comment">##sql_kill_blocking_connection: KILL 4处理建议</span></span><br></pre></td></tr></table></figure>
<h3 id="4-找到锁源的thread-id"><a href="#4-找到锁源的thread-id" class="headerlink" title="4. 找到锁源的thread_id"></a>4. 找到锁源的thread_id</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM performance_schema.threads WHERE processlist_id=4\G;</span><br><span class="line"><span class="comment">## THREAD_ID: 29</span></span><br></pre></td></tr></table></figure>
<h3 id="5-找到锁源的SQL语句"><a href="#5-找到锁源的SQL语句" class="headerlink" title="5. 找到锁源的SQL语句"></a>5. 找到锁源的SQL语句</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 当前在执行的语句</span><br><span class="line">SELECT * FROM performance_schema.`events_statements_current` WHERE thread_id=29;</span><br><span class="line">SQL_TEXT: UPDATE t100w SET k1=<span class="string">&#x27;av&#x27;</span> WHERE id=10</span><br><span class="line">-- 执行语句的历史</span><br><span class="line">SELECT * FROM performance_schema.`events_statements_history` WHERE thread_id=29;</span><br></pre></td></tr></table></figure>

<h2 id="10-主从优化："><a href="#10-主从优化：" class="headerlink" title="10.主从优化："></a>10.主从优化：</h2><h3 id="10-1-5-7-从库多线程MTS"><a href="#10-1-5-7-从库多线程MTS" class="headerlink" title="10.1 5.7 从库多线程MTS"></a>10.1 5.7 从库多线程MTS</h3><p>问题：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://pincheng.org/forward/2c1ca365.html#6-%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6-%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90">主从延时</a><br>基本要求:</p>
<ul>
<li>5.7以上的版本(忘记小版本)，必须开启GTID </li>
<li>binlog必须是row模式  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">slave-parallel-type=LOGICAL_CLOCK</span><br><span class="line">slave-parallel-workers=16 //并发sql线程数量</span><br><span class="line">master_info_repository=TABLE //master_info 已表的形式存放</span><br><span class="line">relay_log_info_repository=TABLE /relay_info 已表的形式存放</span><br><span class="line">relay_log_recovery=ON</span><br></pre></td></tr></table></figure>
<h3 id="5-7"><a href="#5-7" class="headerlink" title="5.7:"></a>5.7:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slave-parallel-type=LOGICAL_CLOCK</span><br><span class="line">slave-parallel-workers=8</span><br><span class="line">cpu核心数作为标准</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=<span class="string">&#x27;10.0.0.128&#x27;</span>,</span><br><span class="line">  MASTER_USER=<span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">  MASTER_PASSWORD=<span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">  MASTER_PORT=3307,</span><br><span class="line">  MASTER_AUTO_POSITION=1;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">饼铛</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://cakepanit.com/forward/14a32ee2.html">https://cakepanit.com/forward/14a32ee2.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://cakepanit.com" target="_blank">Maxbit</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96/">数据库优化</a></div><div class="post_share"><div class="social-share" data-image="/images/img-71.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/DGaBgCC38vJiNnurYYFbtahoFWFNDF4hc6.png" target="_blank"><img class="post-qr-code-img" src="/img/DGaBgCC38vJiNnurYYFbtahoFWFNDF4hc6.png" alt="狗狗币(DogeCoin)"/></a><div class="post-qr-code-desc">狗狗币(DogeCoin)</div></li><li class="reward-item"><a href="/img/bc1qj9u4lk9nj8jgmq6rzcddc70ppqjq9vldrjngct.png" target="_blank"><img class="post-qr-code-img" src="/img/bc1qj9u4lk9nj8jgmq6rzcddc70ppqjq9vldrjngct.png" alt="比特币(BitCoin)"/></a><div class="post-qr-code-desc">比特币(BitCoin)</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/forward/fb94f251.html"><img class="prev-cover" src="/images/img-100.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis-5.0.5介绍与C7下的编译安装</div></div></a></div><div class="next-post pull-right"><a href="/forward/c3e55136.html"><img class="next-cover" src="/images/img-71.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL-MyCAT多主多从环境下实现表的水平拆分</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/forward/74c8159a.html" title="MySQL-MHA+Atlas+VIP+Binlog server实现MySQL的高可用和读写分离"><img class="cover" src="/images/img-71.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-30</div><div class="title">MySQL-MHA+Atlas+VIP+Binlog server实现MySQL的高可用和读写分离</div></div></a></div><div><a href="/forward/3053135c.html" title="MySQL-InnoDB存储引擎&优化"><img class="cover" src="/images/img-71.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-11</div><div class="title">MySQL-InnoDB存储引擎&优化</div></div></a></div><div><a href="/forward/557ea64b.html" title="MySQL-MyCAT多主多从环境下实现表的垂直拆分"><img class="cover" src="/images/img-71.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-05</div><div class="title">MySQL-MyCAT多主多从环境下实现表的垂直拆分</div></div></a></div><div><a href="/forward/c919a25c.html" title="MySQL-MHA的VIP高可用_邮件告警"><img class="cover" src="/images/img-71.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-29</div><div class="title">MySQL-MHA的VIP高可用_邮件告警</div></div></a></div><div><a href="/forward/bbb9c58b.html" title="MySQL-MHA环境准备_搭建_故障恢复"><img class="cover" src="/images/img-71.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-28</div><div class="title">MySQL-MHA环境准备_搭建_故障恢复</div></div></a></div><div><a href="/forward/49de8711.html" title="MySQL-锁"><img class="cover" src="/images/img-71.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-11</div><div class="title">MySQL-锁</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">饼铛</div><div class="author-info__description">Do one's level best and leave the rest to God's will.</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://t.me/joinchat/c_ParmoHMmU5MDM9" rel="external nofollow noreferrer" target="_blank" title="Telegram"><i class="fab fa-telegram-plane"></i></a><a class="social-icon" href="https://qm.qq.com/cgi-bin/qm/qr?k=Q1N9l3isk8O_i5awFwO-blAoPH7PUeb4&amp;noverify=0" rel="external nofollow noreferrer" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="mailto:flybaf740@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://music.163.com/playlist?id=5434811591" rel="external nofollow noreferrer" target="_blank" title="Netease"><i class="fas fa-record-vinyl"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">2021年2月博客改版。本地容器化，支持：全站https，http/3，Gzip，Brotli压缩，页面压缩</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">0.环境准备：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BC%98%E5%8C%96%E8%8C%83%E5%9B%B4%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">1.优化范围：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%B1%82%E9%9D%A2%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.</span> <span class="toc-text">2.操作系统层面优化工具介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1top"><span class="toc-number">3.1.</span> <span class="toc-text">2.1top</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2iostat"><span class="toc-number">3.2.</span> <span class="toc-text">2.2iostat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E7%BB%BC%E5%90%88%E5%88%A4%E6%96%AD"><span class="toc-number">3.3.</span> <span class="toc-text">2.3综合判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4vmstat"><span class="toc-number">3.4.</span> <span class="toc-text">2.4vmstat</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.</span> <span class="toc-text">3.数据库优化工具介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF%E5%88%86%E8%A7%A3"><span class="toc-number">5.</span> <span class="toc-text">4.优化思路分解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%A1%AC%E4%BB%B6%E4%BC%98%E5%8C%96"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 硬件优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1%E4%B8%BB%E6%9C%BA"><span class="toc-number">5.1.1.</span> <span class="toc-text">4.1.1主机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2%E5%86%85%E5%AD%98"><span class="toc-number">5.1.2.</span> <span class="toc-text">4.1.2内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3%E7%A3%81%E7%9B%98%E9%80%89%E6%8B%A9"><span class="toc-number">5.1.3.</span> <span class="toc-text">4.1.3磁盘选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-4%E5%AD%98%E5%82%A8"><span class="toc-number">5.1.4.</span> <span class="toc-text">4.1.4存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5%E7%BD%91%E7%BB%9C"><span class="toc-number">5.1.5.</span> <span class="toc-text">4.1.5网络</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">5.操作系统优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1Swap%E8%B0%83%E6%95%B4"><span class="toc-number">6.1.</span> <span class="toc-text">5.1Swap调整</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%BA%94%E7%94%A8%E7%AB%AF"><span class="toc-number">7.</span> <span class="toc-text">6.应用端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">7.参数优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-max-connections-%E6%9C%80%E5%A4%A7%E8%BF%9E%E6%8E%A5%E6%95%B0"><span class="toc-number">8.1.</span> <span class="toc-text">7.1:max_connections 最大连接数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-back-log-%E9%A2%84%E5%A4%87%E8%BF%9E%E6%8E%A5%E6%95%B0"><span class="toc-number">8.2.</span> <span class="toc-text">7.2:back_log 预备连接数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-wait-timeout%E5%92%8Cinteractive-timeout-%E4%BC%9A%E8%AF%9D%E8%B6%85%E6%97%B6"><span class="toc-number">8.3.</span> <span class="toc-text">7.3:wait_timeout和interactive_timeout  会话超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-key-buffer-size-%E4%B8%B4%E6%97%B6%E8%A1%A8%E7%9B%B8%E5%85%B3"><span class="toc-number">8.4.</span> <span class="toc-text">7.4:key_buffer_size 临时表相关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-query-cache-size-%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="toc-number">8.5.</span> <span class="toc-text">7.5:query_cache_size 查询缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-sort-buffer-size-%E4%BC%9A%E8%AF%9D%E6%8E%92%E5%BA%8F%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">8.6.</span> <span class="toc-text">7.6:sort_buffer_size 会话排序缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-max-allowed-packet-%E6%8E%A5%E6%94%B6%E6%9C%80%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%8C%85%E5%A4%A7%E5%B0%8F"><span class="toc-number">8.7.</span> <span class="toc-text">7.7:max_allowed_packet 接收最大数据包大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-8-join-buffer-size-%E5%85%B3%E8%81%94%E8%A1%A8%E7%BC%93%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="toc-number">8.8.</span> <span class="toc-text">7.8:join_buffer_size 关联表缓存大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-9-thread-cache-size-%E9%A2%84%E5%88%86%E9%85%8D%E4%BF%9D%E7%95%99%E7%BA%BF%E7%A8%8B"><span class="toc-number">8.9.</span> <span class="toc-text">7.9:thread_cache_size 预分配保留线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-10-innodb-buffer-pool-size-%E6%95%B0%E6%8D%AE%E9%A1%B5%E7%B4%A2%E5%BC%95%E7%BC%93%E5%86%B2%E5%A4%A7%E5%B0%8F"><span class="toc-number">8.10.</span> <span class="toc-text">7.10:innodb_buffer_pool_size 数据页索引缓冲大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-11-innodb-flush-log-at-trx-commit-%E6%8E%A7%E5%88%B6redo-buffer-%E5%88%B7%E5%86%99%E7%AD%96%E7%95%A5"><span class="toc-number">8.11.</span> <span class="toc-text">7.11:innodb_flush_log_at_trx_commit 控制redo buffer 刷写策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-12-innodb-thread-concurrency-%E5%A4%9A%E6%A0%B8%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%E6%8E%A7%E5%88%B6"><span class="toc-number">8.12.</span> <span class="toc-text">7.12:innodb_thread_concurrency 多核并发处理控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-13-innodb-log-buffer-size-redo%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E5%B0%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">8.13.</span> <span class="toc-text">7.13:innodb_log_buffer_size  redo缓冲区大小控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-14-innodb-log-file-size-100M-redo%E6%97%A5%E5%BF%97%E4%B8%AA%E6%95%B0%E6%8E%A7%E5%88%B6"><span class="toc-number">8.14.</span> <span class="toc-text">7.14:innodb_log_file_size &#x3D; 100M redo日志个数控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-15-read-buffer-size-1M-%E9%A1%BA%E5%BA%8F%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">8.15.</span> <span class="toc-text">7.15:read_buffer_size &#x3D; 1M 顺序查询缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-16-read-rnd-buffer-size-1M-%E9%9A%8F%E6%9C%BA%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">8.16.</span> <span class="toc-text">7.16:read_rnd_buffer_size &#x3D; 1M 随机查询缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-17-bulk-insert-buffer-size-8M-%E6%8F%92%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E5%B0%8F"><span class="toc-number">8.17.</span> <span class="toc-text">7.17:bulk_insert_buffer_size &#x3D; 8M 插入缓冲区大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-18-binary-log-binlog%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0"><span class="toc-number">8.18.</span> <span class="toc-text">7.18:binary log binlog相关参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-19-%E5%AE%89%E5%85%A8%E5%8F%82%E6%95%B0"><span class="toc-number">8.19.</span> <span class="toc-text">7.19:安全参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96%E7%BB%93%E6%9E%9C"><span class="toc-number">9.</span> <span class="toc-text">8. 参数优化结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="toc-number">9.1.</span> <span class="toc-text">8.1测试：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E9%94%81%E7%9A%84%E7%9B%91%E6%8E%A7%E5%8F%8A%E5%A4%84%E7%90%86"><span class="toc-number">10.</span> <span class="toc-text">9.锁的监控及处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E9%94%81%E7%AD%89%E5%BE%85%E6%A8%A1%E6%8B%9F"><span class="toc-number">10.1.</span> <span class="toc-text">9.1 锁等待模拟</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%9C%8B%E6%9C%89%E6%B2%A1%E6%9C%89%E9%94%81%E7%AD%89%E5%BE%85"><span class="toc-number">10.2.</span> <span class="toc-text">1. 看有没有锁等待</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E5%93%AA%E4%B8%AA%E4%BA%8B%E5%8A%A1%E5%9C%A8%E7%AD%89%E5%BE%85-%E8%A2%AB%E9%98%BB%E5%A1%9E%E4%BA%86"><span class="toc-number">10.3.</span> <span class="toc-text">2. 查看哪个事务在等待(被阻塞了)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E9%94%81%E6%BA%90-%E8%B0%81%E9%94%81%E7%9A%84%E6%88%91"><span class="toc-number">10.4.</span> <span class="toc-text">3.查看锁源,谁锁的我!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%89%BE%E5%88%B0%E9%94%81%E6%BA%90%E7%9A%84thread-id"><span class="toc-number">10.5.</span> <span class="toc-text">4. 找到锁源的thread_id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%89%BE%E5%88%B0%E9%94%81%E6%BA%90%E7%9A%84SQL%E8%AF%AD%E5%8F%A5"><span class="toc-number">10.6.</span> <span class="toc-text">5. 找到锁源的SQL语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E4%B8%BB%E4%BB%8E%E4%BC%98%E5%8C%96%EF%BC%9A"><span class="toc-number">11.</span> <span class="toc-text">10.主从优化：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-5-7-%E4%BB%8E%E5%BA%93%E5%A4%9A%E7%BA%BF%E7%A8%8BMTS"><span class="toc-number">11.1.</span> <span class="toc-text">10.1 5.7 从库多线程MTS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7"><span class="toc-number">11.2.</span> <span class="toc-text">5.7:</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/forward/852a3e1.html" title="GitLab-CI/CD"><img src="/images/pasted-90.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GitLab-CI/CD"/></a><div class="content"><a class="title" href="/forward/852a3e1.html" title="GitLab-CI/CD">GitLab-CI/CD</a><time datetime="2021-08-25T02:27:00.000Z" title="发表于 2021-08-25 10:27:00">2021-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/forward/ff7280bd.html" title="GitLab-CI语法"><img src="/images/pasted-90.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GitLab-CI语法"/></a><div class="content"><a class="title" href="/forward/ff7280bd.html" title="GitLab-CI语法">GitLab-CI语法</a><time datetime="2021-08-24T05:25:00.000Z" title="发表于 2021-08-24 13:25:00">2021-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/forward/d12df344.html" title="Golang-函数"><img src="/images/pasted-2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Golang-函数"/></a><div class="content"><a class="title" href="/forward/d12df344.html" title="Golang-函数">Golang-函数</a><time datetime="2021-08-23T10:27:00.000Z" title="发表于 2021-08-23 18:27:00">2021-08-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/forward/55d102bd.html" title="k8s企业级DevOps实践-Kong的两种打开方式"><img src="/images/pasted-84.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s企业级DevOps实践-Kong的两种打开方式"/></a><div class="content"><a class="title" href="/forward/55d102bd.html" title="k8s企业级DevOps实践-Kong的两种打开方式">k8s企业级DevOps实践-Kong的两种打开方式</a><time datetime="2021-08-16T06:53:00.000Z" title="发表于 2021-08-16 14:53:00">2021-08-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/forward/b36ee5af.html" title="k8s企业级DevOps实践-Kong in kubernetes"><img src="/images/pasted-84.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s企业级DevOps实践-Kong in kubernetes"/></a><div class="content"><a class="title" href="/forward/b36ee5af.html" title="k8s企业级DevOps实践-Kong in kubernetes">k8s企业级DevOps实践-Kong in kubernetes</a><time datetime="2021-08-11T14:10:00.000Z" title="发表于 2021-08-11 22:10:00">2021-08-11</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/images/img-71.png')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By 饼铛</div><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img class="icp-icon" src="/img/yp.png"><span>提供CDN加速</span></a><span class="footer-separator">|</span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/"><img class="icp-icon" src="/img/ba.png"><span>皖ICP备2021005605</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="5434811591" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/img/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/haru02.model.json"},"bottom":-40,"display":{"position":"right","width":190,"height":380,"hOffset":80},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>